---
title: "Association of COVID-19 vaccination inequity and mortality in Chicago"
author: Sharon Zeng
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
--- 



```{r global_options, include=FALSE, cache = FALSE}
library(knitr)
library(kableExtra)
library(ggpubr)
library(sf)
library(tigris)
library(viridis)
library(tidycensus)
library(lubridate)
library(ggstance)
library(plotly)
library(Rmisc)
library(tidyverse)
library(RColorBrewer)
library(ggsci)
library(zoo)
library(gridExtra)
library(grid)
library(lattice)
library(latticeExtra)
library(MASS)
library(DescTools)
library(lme4)
library(sjPlot)
library(ggeffects)
library(parameters)
library(webshot)
library(janitor)
library(spatstat)
library(openxlsx)
library(performance)
library(ggrepel)
library(ggsflabel)
library(tableone)
library(Hmisc)
library(weights)
library(car)
library(ggmap)
library(tigris)
library(sp)
library(tidycensus)
library(tidygeocoder)
library(cowplot)
library(magick)
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE, fig.height = 5, fig.width = 9)
options(tigris_use_cache = TRUE, tinytex.verbose = TRUE)
```

Data from the Chicago Department of Public Health (CDPH) 

* [Vaccine source data](https://data.cityofchicago.org/Health-Human-Services/COVID-19-Vaccinations-by-ZIP-Code/553k-3xzc) (updated 12/30/21, downloaded 1/2/22)
* [Cases and deaths by zip code source data](https://data.cityofchicago.org/Health-Human-Services/COVID-19-Cases-Tests-and-Deaths-by-ZIP-Code/yhhz-zm2v) (updated 12/30/21, downloaded 1/2/22)
* [Medical examiner case archive data](https://datacatalog.cookcountyil.gov/Public-Safety/Medical-Examiner-Case-Archive-COVID-19-Related-Dea/3trz-enys) (updated 1/2/22, downloaded 1/2/22)
* [Chicago population counts](https://data.cityofchicago.org/Health-Human-Services/Chicago-Population-Counts/85cm-7uqa)
* [Demographics in zip codes (U.S. Census Bureau, 2019 ACS 5-year estimates)](https://data.cityofchicago.org/Health-Human-Services/Chicago-Population-Counts/85cm-7uqa)
* [More ZCTA demographics (U.S. Census Bureau, 2019 ACS 5-year estimates - Economic and Social Characteristics)](https://www.census.gov/acs/www/data/data-tables-and-tools/data-profiles/)
* [Zip code and census tract overlap for population estimates (HUD PD&R) ZIP-TRACT 4th quarter 2019, downloaded 1/16/22](https://www.huduser.gov/portal/datasets/usps_crosswalk.html)

```{r zip geometry}
#zip_codes <- zctas(cb = TRUE, class = "sf")

#save(file = "zip_code_data.R", zip_codes)

load("zip_code_data.R")

zips_sf <- zip_codes %>%
  dplyr:: select(zip = ZCTA5CE10, geometry) %>%
  mutate(zip = as.character(zip))
```

```{r Census demographic data}

demo_by_zip <- read_csv("Chicago_Population_Counts_121021.csv") %>%
  filter(`Geography Type` != "Citywide", Year == 2019) %>%
  rename(zip = Geography, population = `Population - Total`) %>%
  mutate(zip = as.character(zip)) %>%
  dplyr::select(-`Geography Type`, -`Record ID`)

```

```{r CDPH covid data}
covid_by_zip <-
  read_csv(
    "COVID-19_Cases_Tests_and_Deaths_by_ZIP_Code_010222.csv"
  ) %>%
  mutate(
    zip = as.character(`ZIP Code`),
    week_st = mdy(`Week Start`),
    week_end = mdy(`Week End`)
  ) %>%
  mutate(int = interval(week_st, week_end)) %>%
  #get weeks since beginning of pandemic (1 = first week of pandemic in US/starts indexing at 1)
  mutate(week = (min(week_st) %--% week_st) %/% weeks(1) + 1) %>%
  dplyr:: select(-`Week Number`,-`ZIP Code`,-`Row ID`)

write.csv(covid_by_zip, "covid_by_zip.csv")

# use 2019 population estimates
covid_by_zip <- demo_by_zip %>%
  dplyr::select(zip, population) %>%
  rename(population2019 = population) %>%
  right_join(covid_by_zip) %>%
  mutate(`Case Rate - Weekly` = `Cases - Weekly`*100000/population2019,
         `Case Rate - Cumulative` = `Cases - Cumulative`*100000/population2019,
         `Test Rate - Weekly` = `Tests - Weekly`*100000/population2019,
         `Test Rate - Cumulative` = `Tests - Cumulative`*100000/population2019,
         `Percent Tested Positive - Weekly` = `Tests - Weekly`*`Population`/population2019,
         `Percent Tested Positive - Cumulative` = `Tests - Cumulative`*`Population`/population2019,
         `Death Rate - Weekly` = `Deaths - Weekly`*100000/population2019,
         `Death Rate - Cumulative` = `Deaths - Cumulative`*100000/population2019) %>%
  dplyr::select(-`Population`) %>%
  rename(population = population2019)
  
```

```{r vaccination data}
vax_by_zip <-
  read_csv("COVID-19_Vaccinations_by_ZIP_Code_010222.csv") %>%
  mutate(zip = as.character(`Zip Code`),
         date = mdy(Date)) %>%
  mutate(week_st = floor_date(date, unit = "weeks", week_start = 7)) %>%
  #get week totals from reported daily numbers
  dplyr::group_by(week_st, zip) %>%
  mutate(
    cumulative_doses = max(`Total Doses - Cumulative`),
    cumulative_first = max(`1st Dose - Cumulative`),
    cumulative_complete = max(`Vaccine Series Completed - Cumulative`),
    cumulative_pct_first = max(`1st Dose - Percent Population`)*100,
    cumulative_pct_complete = max(`Vaccine Series Completed  - Percent Population`)*100,
    doses_weekly = sum(`Total Doses - Daily`),
    first_weekly = sum(`1st Dose - Daily`),
    complete_weekly = sum(`Vaccine Series Completed - Daily`)) %>%
    ungroup()

write.csv(vax_by_zip, "vax_by_zip.csv")

vax_by_zip <- vax_by_zip %>%
  #only keep 1 row per week
  dplyr:: select(zip, week_st, cumulative_doses, cumulative_first, cumulative_complete, cumulative_pct_first, cumulative_pct_complete, doses_weekly, first_weekly, `1st Dose - Cumulative`, `Population`) %>%
  filter(`1st Dose - Cumulative`== cumulative_first) %>%
  dplyr:: select(-`1st Dose - Cumulative`) %>%
  distinct() %>%
  rename(population = `Population`) %>%
  arrange(week_st, zip) %>%
  mutate(population = case_when(zip == "60827" ~ 28483,
                                zip == "60707" ~ 43093,
                                TRUE ~ as.numeric(population)))

#define rollout phases
vax_by_zip <- vax_by_zip %>%
  mutate(
    phase = case_when(
      week_st < mdy("01/25/2021") ~ "1A",
      week_st >= mdy("01/25/2021") & week_st < mdy("03/29/2021") ~ "1B",
      week_st >= mdy("03/29/2021") & week_st < mdy("04/19/2021") ~ "1C", 
      week_st >= mdy("04/19/2021") ~ "2"))
```
 
```{r merge CDPH data}
# #merge datasets, keeping all rows from covid data (because vaccinations started later)
# 
merged_df <-  left_join(covid_by_zip, vax_by_zip) %>%
    relocate(week, zip, week_st, week_end) %>%
    dplyr:: select(-`Week Start`,-`Week End`) %>%
    arrange(week_st, zip)
 
  #renaming stuff
colnames(merged_df) <-
    str_replace_all(colnames(merged_df), " - ", " ") %>%
    str_replace_all(" ", "_") %>%
    str_to_lower() %>%
    str_replace_all("1st", "first") %>%
    str_replace_all("percent", "pct") %>%
    str_replace_all("daily", "weekly") %>%
    str_replace_all("__", "_")
 
merged_df <- merged_df %>%
    dplyr::group_by(zip, week) %>%
    #first_dose_rate = number of people starting vaccination series/100000 population
    mutate(
      pct_complete_present = max(cumulative_pct_complete),
      pct_first_present = max(cumulative_pct_first),
      first_dose_rate = first_weekly * 100000 / population)%>%
    #remove rows with missing/not reported zip codes (907 cases cumulatively)
    filter(is.na(zip) == FALSE) %>%
    ungroup()
  
```

```{r dates and legends}

max_date <- max(merged_df$week_st)

# Phase 1A: 12/15/20
# Phase 1B: 1/25/21
# Phase 1C: 3/29/21
# Phase 2: 4/19/21

phases <-
  mdy(c("12/15/20", "1/12/21", "01/25/21", "03/29/21", "04/19/21"))
phase_labels <- factor(
  c(
    "Phase 1A begins",
    "4 weeks after Phase 1A",
    "Phase 1B begins",
    "Phase 1C begins",
    "Phase 2 begins"
  ),
  levels = c("Phase 1A begins",
    "4 weeks after Phase 1A",
    "Phase 1B begins",
    "Phase 1C begins",
    "Phase 2 begins"))
phase_data <- data.frame(phase_labels, phases)

pop_limit <- 10000

# x-axis
leftdate_cutoff <- mdy("3/1/20")
rightdate_cutoff <- mdy("12/5/21")

secondwavepeak <- mdy("12/13/20")
alphawavepeak <- mdy("5/9/21")

# dates to group zip codes by
alpha_grouping_date_chr <- "3/28/21"
alpha_grouping_date <- mdy(alpha_grouping_date_chr)
alpha_grouping_date_name <- paste0("Grouped by relative level of 1st doses 6 weeks before peak of alpha wave ", alpha_grouping_date_chr)
alpha_group_legend <- "Vaccination Group"

delta_grouping_date_chr <- "8/1/21"
delta_grouping_date <- mdy(delta_grouping_date_chr)
delta_grouping_date_name <- paste0("Grouped by relative level of 1st doses 6 weeks before peak of delta wave ", delta_grouping_date_chr)
delta_group_legend <- paste0("% of Population with First Doses\n(", delta_grouping_date_chr, ")")

secondwave_st <- mdy("8/9/20")
alphawave_st <- alpha_grouping_date
alphawave_end <- mdy("6/13/21")
deltawave_st <- delta_grouping_date
deltawave_end <- mdy("10/31/21")

joined_df <- merged_df %>%
  filter(zip != "60827" & zip != "60707") %>%
  filter(week_st <= rightdate_cutoff) %>%
  filter(population > pop_limit)

outliers <- filter(merged_df, population < pop_limit | zip == 60707 | zip == 60827) %>%
  dplyr::select(zip, population, zip_code_location) %>%
  distinct()

```


```{r medical examiner data}

# get Census tracts 

# sfgeo <- get_acs(state = "IL", county = "Cook", geography = "tract", variable = "B01001_001", year = 2019, geometry = TRUE)
# 
# save(file = "cookcountytracts.R", sfgeo)

load("cookcountytracts.R")

ME_covid_deaths <- read_csv("Medical_Examiner_Case_Archive_COVID-19_Related_Deaths_010222.csv") %>%
  separate(`Date of Death`, c("death_date", NA, NA), sep = " ") %>%
  mutate(death_date = mdy(death_date)) %>%
  mutate(week_st = floor_date(death_date, unit = "weeks", week_start = 7))

# select deaths with geocoded addresses
ME_covid_deaths_clean <- ME_covid_deaths %>%
  filter(is.na(longitude) == FALSE) %>%
  st_as_sf(coords = c("longitude", "latitude"),
           crs = st_crs(sfgeo))

# add census tract
ME_covid_deaths_clean <- st_join(ME_covid_deaths_clean, sfgeo)

# add correct incident zip code
ME_covid_deaths_clean <- st_join(ME_covid_deaths_clean, zips_sf) %>%
  rename(tract = NAME) %>%
  separate(GEOID, c(NA, "tract_num"), sep = -6, remove = FALSE) %>%
  mutate(zip_match = case_when(`Incident Zip Code` == zip ~ 1,
                               TRUE ~ 0))

# how many deaths had incorrectly reported zip codes?
paste0("Incorrectly/correctly reported zip codes: ", table(ME_covid_deaths_clean$zip_match)[1], "/", table(ME_covid_deaths_clean$zip_match)[2])

# filter by addresses in Chicago
ME_to_map <- ME_covid_deaths_clean[st_within(ME_covid_deaths_clean$geometry, left_join(covid_by_zip, zips_sf)$geometry) %>% lengths > 0,] %>%
  dplyr::select(-`Incident Zip Code`, zip_match) %>%
  filter(!zip %in% outliers$zip)  %>%
  filter(`Incident City` == "CHICAGO")

```

```{r alpha clustering}

n_groups <- 3

# have to change manually

alpha_groups <- joined_df %>%
  filter(week_st == alpha_grouping_date, population > pop_limit) %>%
  dplyr::select(zip, cumulative_pct_first, cumulative_first, zip, population, zip_code_location) %>%
  arrange(cumulative_pct_first) %>%
  mutate(rank = row_number()) %>%
  mutate(vax_group_alpha = case_when(
    rank <= 13 ~ "Least vaccinated quartile",
    rank >= 40 ~ "Most vaccinated quartile",
    TRUE ~ "Middle 25-75%")) %>%
  mutate(vax_group_alpha = factor(vax_group_alpha, 
                            levels = c("Least vaccinated quartile", 
                                       "Middle 25-75%", 
                                       "Most vaccinated quartile"))) %>%
  dplyr::select(-rank) %>%
  rename(pct_first_alpha = cumulative_pct_first,
         first_doses_alpha = cumulative_first)

n_labels_alpha <- levels(alpha_groups$vax_group_alpha)

alpha_groups %>%
  dplyr::group_by(vax_group_alpha) %>%
  dplyr::summarise(population = sum(population))

table(alpha_groups$vax_group_alpha)

```

```{r delta clustering}

n_groups <- 3

# have to change manually

delta_groups <- joined_df %>%
  filter(week_st == delta_grouping_date, population > pop_limit) %>%
  dplyr::select(zip, cumulative_pct_first, cumulative_first, zip, population, zip_code_location) %>%
  arrange(cumulative_pct_first) %>%
  mutate(rank = row_number()) %>%
  mutate(vax_group_delta = case_when(
    rank <= 13 ~ "[36.4, 49.5]",
    rank >= 40 ~ "[65.4, 79.7]",
    TRUE ~ "[50.5, 64.9]")) %>%
  mutate(vax_group_delta = factor(vax_group_delta, 
                            levels = c("[36.4, 49.5]", 
                                       "[50.5, 64.9]", 
                                       "[65.4, 79.7]"))) %>%
  dplyr::select(-rank) %>%
  rename(pct_first_delta = cumulative_pct_first,
         first_doses_delta = cumulative_first)

n_labels_delta <- levels(delta_groups$vax_group_delta)

delta_groups %>%
  dplyr::group_by(vax_group_delta) %>%
  dplyr::summarise(population = sum(population))

table(delta_groups$vax_group_delta)

```

```{r datasets for graphing}

# weeks to roll average over
k <- 5

to_graph_alpha <- dplyr::select(alpha_groups, c(zip, vax_group_alpha)) %>%
  left_join(joined_df) %>%
  filter(week_st >= leftdate_cutoff, week_st <= deltawave_end) %>%
  arrange(vax_group_alpha, week_st) %>%
  dplyr::group_by(week_st, week, vax_group_alpha) %>%
  dplyr::summarise(
    deathratesd = sqrt(wtd.var(death_rate_weekly, population)),
    death_rate_weekly = weighted.mean(death_rate_weekly, population),
    caseratesd = sqrt(wtd.var(case_rate_weekly, population)),
    case_rate_weekly = weighted.mean(case_rate_weekly, population),
    first_dose_weekly = sum(first_weekly) * 100000 / sum(population),
    deathscumulativesd = sqrt(wtd.var(death_rate_cumulative, population)),
    deaths_cumulative = weighted.mean(death_rate_cumulative, population),
    first_dose_cumulative = sum(cumulative_first),
    cumulative_pct_first = weighted.mean(cumulative_pct_first*100, population),
    population = sum(population)) %>%
    #rolling average mortality rate over k weeks)
  dplyr::group_by(vax_group_alpha) %>%
  mutate(mort_roll = zoo::rollmean(death_rate_weekly, k, fill = NA)) %>%
  ungroup() %>%
  mutate(vax_group_alpha = case_when(
    vax_group_alpha == n_labels_alpha[1] ~ "Least vaccinated quartile",
    vax_group_alpha == n_labels_alpha[2] ~ "Middle 25-75%",
    vax_group_alpha == n_labels_alpha[3] ~ "Most vaccinated quartile"))

to_graph_delta <- dplyr::select(delta_groups, c(zip, vax_group_delta)) %>%
  left_join(joined_df) %>%
  filter(week_st >= secondwave_st, week_st <= deltawave_end) %>%
  arrange(vax_group_delta, week_st) %>%
  dplyr::group_by(week_st, week, vax_group_delta) %>%
  dplyr::summarise(
    deathratesd = sqrt(wtd.var(death_rate_weekly, population)),
    death_rate_weekly = weighted.mean(death_rate_weekly, population),
    caseratesd = sqrt(wtd.var(case_rate_weekly, population)),
    case_rate_weekly = weighted.mean(case_rate_weekly, population),
    first_dose_weekly = sum(first_weekly) * 100000 / sum(population),
    deathscumulativesd = sqrt(wtd.var(death_rate_cumulative, population)),
    deaths_cumulative = weighted.mean(death_rate_cumulative, population),
    first_dose_cumulative = sum(cumulative_first),
    cumulative_pct_first = weighted.mean(cumulative_pct_first*100, population),
    population = sum(population)) %>%
    #rolling average mortality rate over k weeks)
  dplyr::group_by(vax_group_delta) %>%
  mutate(mort_roll = zoo::rollmean(death_rate_weekly, k, fill = NA)) %>%
  ungroup()
```

```{r n groups and graphing aesthetics}

graphcolors <- pal_npg("nrc")(n_groups)
# %>%
#   rev()
# graphcolors <- c("#BFD2F4", "#608FE2", "#004CD1")

graphcolors[2] <- "#3fc2e2ff"

mapcolorsblues <- brewer.pal(n_groups, "Blues")
mapcolorsblues[n_groups+1] <- "#A4A4A4"

mapcolorscustom <- graphcolors
mapcolorscustom[n_groups+1] <- "#A4A4A4"

graphshapes <- c(21, 24, 22, 23, 25)[1:n_groups]

linetypes <- c("longdash", "dotdash", "dotted", "dashed", "twodash")

# ggplot layers that get reused a lot

aesthetics <- list(
  annotate("rect", xmin = alphawave_st, xmax = alphawave_end, ymin = -Inf, ymax = Inf,
           alpha = .1, fill = "black"),
  annotate("rect", xmin = deltawave_st, xmax = deltawave_end, ymin = -Inf, ymax = Inf,
           alpha = .1, fill = "black"),
  # geom_vline(data = phase_data, aes(xintercept = phases, 
  #                                   linetype = phase_labels), 
  #            color = "gray50",
  #            key_glyph = "path", 
  #            size = 1),
  # scale_linetype_manual(values = linetypes), 
  scale_fill_manual(values = graphcolors),
  scale_color_manual(values = graphcolors),
  scale_shape_manual(values = graphshapes),
  scale_x_date(date_breaks = "4 weeks", 
               date_minor_breaks = "1 week", 
               guide = guide_axis(angle = 45),
               date_labels = "%b-%d-%Y",
               expand = c(0.01, 0.01)),
  # labs(linetype = "Distribution Phase"),
    theme_bw() +
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(), 
        axis.text=element_text(size=12, 
                               face = "bold"),
        axis.title=element_text(size=14,
                                face = "bold"),
        legend.title = element_text(size = 12,
                                    face = "bold"),
        legend.text = element_text(size = 12),
        legend.key.size = unit(1, "lines")))

alphaperiod <- paste(leftdate_cutoff, alphawave_end, sep = "_")

deltaperiod <- paste(alphawave_end, max(to_graph_delta$week_st), sep = "_")
```

\newpage

# Groups

### eFIGURE 1b: Histograms of groups

```{r}

histstyle <- list(theme_bw(),
  theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(), 
        panel.grid.major.y = element_line(color = "gray20")),
  scale_y_continuous(expand =  expansion(add = c(0, 0.5)),
                     breaks = seq(0, 10, 1)),
  scale_x_continuous(expand = c(0, 0), limits = c(0, 100)),
  theme(axis.text=element_text(size=12,
                               face = "bold"),
        axis.title=element_text(size=12,
                                face = "bold"),
        legend.title = element_text(size = 10,
                                    face = "bold"),
        legend.text = element_text(size = 10),
        legend.key.size = unit(2, "lines")))

alpha_groupinghist <- alpha_groups %>%
  ggplot(aes(pct_first_alpha, 
             fill = vax_group_alpha)) +
    geom_histogram(color = "black") +
  scale_fill_manual(values = graphcolors) +
  labs(fill = alpha_group_legend, 
       y = "Number of Zip Codes\n", 
       x = "% of population with at least 1 dose") +
  histstyle 

alpha_groupinghist

ggsave("alpha_groupinghist.png", alpha_groupinghist, height = 4, width = 7)

delta_groupinghist <- delta_groups %>%
  ggplot(aes(pct_first_delta, 
             fill = vax_group_delta)) +
    geom_histogram(color = "black") +
  scale_fill_manual(values = graphcolors) +
  labs(fill = "Delta Vaccination Group", 
       y = "Number of Zip Codes\n", 
       x = delta_group_legend) +
  histstyle 

delta_groupinghist

ggsave("delta_groupinghist.png", delta_groupinghist, height = 4, width = 7)
```

### eTABLE 3: Zip codes and alpha groups included in analysis

```{r}

groups_tbl <- dplyr::select(alpha_groups, -zip_code_location) %>%
  left_join(dplyr::select(delta_groups, -zip_code_location))

st1 <- groups_tbl %>%
  relocate(
    `ZIP` = zip,
    `Vaccination Group` = vax_group_alpha,
    `Number of First Doses by 3/28/21` = first_doses_alpha,
    `% First Doses by 3/28/21` = pct_first_alpha,
    `Delta Vaccination Group` = vax_group_delta,
    `Number of First Doses by 8/1/21` = first_doses_delta,
    `% First Doses by 8/1/21` = pct_first_delta,
    `Population` = population) %>%
  arrange(`% First Doses by 3/28/21`) %>%
  dplyr::select(-`Delta Vaccination Group`)
  
  
kable(st1,
      caption = "Zip codes included in analysis") %>%
    kable_styling(latex_options = "striped")

write.xlsx(st1, "supptable1_groups.xlsx", row.names = FALSE)
```

## eTABLE 2: Zip codes excluded from analysis/outliers

```{r}
outliers_tbl <- filter(merged_df, week_st == alpha_grouping_date) %>%
  filter(zip %in% outliers$zip) %>%
  dplyr:: select(cumulative_first, cumulative_pct_first, zip, population) %>%
  mutate(group = "Outliers",
         population = case_when(zip == "60827" | zip == "60707" ~ NA_real_,
                                TRUE ~ as.numeric(population))) %>%
  rename(`Vaccination Group` = group,
         `Number of First Doses by 3/28/21` = cumulative_first,
         `% First Doses by 3/28/21` = cumulative_pct_first) %>%
  left_join(filter(merged_df, week_st == delta_grouping_date)) %>%
  rename(`Number of First Doses by 8/1/21` = cumulative_first,
         `% First Doses by 8/1/21` = cumulative_pct_first,
         ZIP = zip,
         Population = population) %>%
  dplyr::select(c(`Vaccination Group`,
         `Number of First Doses by 3/28/21`,
         `% First Doses by 3/28/21`),
         `Number of First Doses by 8/1/21`,
         `% First Doses by 8/1/21`,
         ZIP,
         Population)

kable(outliers_tbl) %>%
  kable_styling(latex_options = "striped")

write.xlsx(outliers_tbl, "supptable2_outliers.xlsx", row.names = FALSE, na = "NA")

```

### For new eTABLE 1? : Groups over time
```{r}

alphagroupsovertime <- filter(joined_df, week_st == alphawave_end, population > pop_limit) %>%
  dplyr::select(zip, cumulative_pct_first) %>%
  arrange(cumulative_pct_first) %>%
  mutate(rank = row_number()) %>%
  mutate(alphawave_end = case_when(
    rank <= 13 ~ "Lowest quartile",
    rank > 39 ~ "Highest quartile",
    TRUE ~ "Middle 25-75%")) %>%
  rename(pct_alpha_end = cumulative_pct_first) %>%
  right_join(dplyr::select(alpha_groups, -zip_code_location)) %>%
  dplyr::select(-c(rank, first_doses_alpha)) %>%
  arrange(pct_first_alpha) %>%
  relocate(c(pct_first_alpha, vax_group_alpha, pct_alpha_end), .after = zip) %>%
  rename(ZIP = zip, 
         `alpha Vaccination Group` = vax_group_alpha,
         `% 1st Doses by 3/28/21` = pct_first_alpha,
         `alpha End Vaccination Quartile` = alphawave_end,
         `% 1st Doses by 6/13/21` = pct_alpha_end,
         Population = population)

table(alphagroupsovertime$`alpha End Vaccination Quartile`)

kable(alphagroupsovertime) %>%
  kable_styling(latex_options = "striped")

write.xlsx(alphagroupsovertime, "newsupptable2alpha.xlsx", row.names = FALSE, na = "NA")

deltagroupsovertime <- filter(joined_df, week_st == rightdate_cutoff, population > pop_limit) %>%
  dplyr::select(zip, cumulative_pct_first) %>%
  arrange(cumulative_pct_first) %>%
  mutate(rank = row_number()) %>%
  mutate(deltawave_end = case_when(
    rank <= 13 ~ "Lowest quartile",
    rank > 39 ~ "Highest quartile",
    TRUE ~ "Middle 25-75%")) %>%
  rename(pct_delta_end = cumulative_pct_first) %>%
  right_join(dplyr::select(delta_groups, -zip_code_location)) %>%
  dplyr::select(-c(rank, first_doses_delta)) %>%
  arrange(pct_first_delta) %>%
  relocate(c(pct_first_delta, vax_group_delta, pct_delta_end), .after = zip) %>%
  rename(ZIP = zip, 
         `Delta Vaccination Group` = vax_group_delta,
         `% 1st Doses by 8/1/21` = pct_first_delta,
         `Delta End Vaccination Quartile` = deltawave_end,
         `% 1st Doses by 12/10/21` = pct_delta_end,
         Population = population)

table(deltagroupsovertime$`Delta End Vaccination Quartile`)

```

## Maps of vaccinations and alpha_groups

### FIGURE 1a: Maps of vaccinations

```{r}

vaxmapstyle <- list(geom_sf_text_repel(aes(label = zip),
                       size = 2.5,
                       # fontface = "bold",
                       nudge_x = 0,
                       nudge_y = 0,
                       point.size = NA,
                       box.padding = 0.1,
                       min.segment.length = 0.1,
                       max.overlaps = Inf),
                    geom_sf(data = ME_to_map, alpha = 0),
    theme_void(), coord_sf(), 
    scale_fill_distiller(trans = "reverse", limits = c(max(groups_tbl$pct_first_delta), min(groups_tbl$pct_first_alpha))),
    scale_color_manual(values = mapcolorscustom),
    labs(color = "Vaccination Group"),
    theme(legend.position = "right", 
        plot.title = element_text(hjust = 0.5),
        legend.title = element_text(size = 10, face = "bold"),
        legend.text = element_text(size = 10),
        legend.key.size = unit(1, "lines")),
  guides(color = guide_legend(override.aes = list(size=4))))

alphavaxmap <- left_join(alpha_groups, zips_sf) %>%
  ggplot(aes(geometry = geometry)) + 
    geom_sf(aes(fill = pct_first_alpha)) +
    vaxmapstyle +
  labs(fill = alpha_group_legend)

alphavaxmap

ggsave("alphavaxmap.pdf", alphavaxmap, height = 7, width = 7)

deltavaxmap <- left_join(delta_groups, zips_sf) %>%
  ggplot(aes(geometry = geometry)) + 
    geom_sf(aes(fill = pct_first_delta)) +
  vaxmapstyle +
  labs(fill = delta_group_legend)

deltavaxmap

ggsave("deltavaxmap.pdf", deltavaxmap, height = 7, width = 7)
```

### eFIGURE 1c: Maps of vaccination groups

```{r}

groupingmapsstyle <- list(geom_sf_text_repel(aes(label = zip),
                       size = 2.5,
                       # fontface = "bold",
                       nudge_x = 0,
                       nudge_y = 0,
                       point.size = NA,
                       box.padding = 0.1,
                       min.segment.length = 0.1,
                       max.overlaps = Inf),
                       geom_sf(data = ME_to_map, alpha = 0),
    theme_void(), coord_sf(), 
    scale_fill_manual(values = mapcolorscustom),
    theme(legend.position = "right", 
        plot.title = element_text(hjust = 0.5),
        legend.title = element_text(size = 10, face = "bold"),
        legend.text = element_text(size = 10),
        legend.key.size = unit(1, "lines")),
  guides(color = guide_legend(override.aes = list(size=4))))

alpha_grouping_map <- left_join(alpha_groups, zips_sf) %>%
  ggplot(aes(geometry = geometry)) + 
    geom_sf(aes(fill = vax_group_alpha)) +
    labs(fill = alpha_group_legend, title = "Distribution of alpha Vaccination Groups", color = "Vaccination Group") +
  groupingmapsstyle

alpha_grouping_map

ggsave("alpha_groupingmap.png", alpha_grouping_map, height = 7, width = 7)

delta_grouping_map <- left_join(delta_groups, zips_sf) %>%
  ggplot(aes(geometry = geometry)) + 
    geom_sf(aes(fill = vax_group_delta)) +
    labs(fill = delta_group_legend, title = "Distribution of Delta Vaccination Groups", color = "Vaccination Group") +
    groupingmapsstyle

delta_grouping_map

ggsave("delta_groupingmap.png", delta_grouping_map, height = 7, width = 7)

```

## Demographics

```{r table 1 data import}

demo_by_zip <- demo_by_zip %>%
  mutate(`Population - Age 18-65` = `Population - Age 18+` - `Population - Age 65+`) %>%
  dplyr::select(!`Population - Age 18-29`:`Population - Age 18+`) %>%
  relocate(`Population - Age 18-65`, .after = `Population - Age 0-17`) %>%
  filter(!zip %in% outliers$zip)

median_age_df <- read_csv("median_age_ACS.csv") %>%
  dplyr::select(`Geographic Area Name`,
                `Estimate!!SEX AND AGE!!Total population`,
                `Estimate!!SEX AND AGE!!Total population!!Median age (years)`) %>%
  separate(`Geographic Area Name`, 
           into = c(NA, "zip")) %>%
  rename(population = `Estimate!!SEX AND AGE!!Total population`,
         `Median Age (Years)` = `Estimate!!SEX AND AGE!!Total population!!Median age (years)`)

economics_social_by_zip <- read_csv("economic_characteristics_ACS.csv") %>%
  left_join(read_csv("social_characteristics_ACS.csv")) %>%
  dplyr::select(`Geographic Area Name`,
                `Estimate!!INCOME AND BENEFITS (IN 2019 INFLATION-ADJUSTED DOLLARS)!!Total households!!Median household income (dollars)`,
                `Percent!!HEALTH INSURANCE COVERAGE!!Civilian noninstitutionalized population!!With health insurance coverage`,
                `Estimate!!HEALTH INSURANCE COVERAGE!!Civilian noninstitutionalized population!!With health insurance coverage`,
                `Estimate!!HEALTH INSURANCE COVERAGE!!Civilian noninstitutionalized population`,
                `Percent!!EDUCATIONAL ATTAINMENT!!Population 25 years and over!!High school graduate or higher`,
                `Estimate!!EDUCATIONAL ATTAINMENT!!Population 25 years and over!!High school graduate or higher`,
                `Estimate!!EDUCATIONAL ATTAINMENT!!Population 25 years and over`) %>%
  separate(`Geographic Area Name`, 
           into = c(NA, "zip")) %>%
  rename(`Median Household Income ($)` = 
           `Estimate!!INCOME AND BENEFITS (IN 2019 INFLATION-ADJUSTED DOLLARS)!!Total households!!Median household income (dollars)`,
         `% Health Insurance` = 
           `Percent!!HEALTH INSURANCE COVERAGE!!Civilian noninstitutionalized population!!With health insurance coverage`,
         healthinsuranceest = 
           `Estimate!!HEALTH INSURANCE COVERAGE!!Civilian noninstitutionalized population!!With health insurance coverage`,
         civiliannoninst = 
           `Estimate!!HEALTH INSURANCE COVERAGE!!Civilian noninstitutionalized population`,
         `% High School Graduate or Higher` = 
           `Percent!!EDUCATIONAL ATTAINMENT!!Population 25 years and over!!High school graduate or higher`,
         highschoolest = 
           `Estimate!!EDUCATIONAL ATTAINMENT!!Population 25 years and over!!High school graduate or higher`,
         pop25over = 
           `Estimate!!EDUCATIONAL ATTAINMENT!!Population 25 years and over`) %>%
  right_join(demo_by_zip) %>%
  left_join(median_age_df)

economics_social_merged <- economics_social_by_zip %>%
  mutate_at(vars(starts_with("Population - ")), 
                 list(~ ./ population * 100)) %>%
  dplyr::select(-c(healthinsuranceest, highschoolest, civiliannoninst, pop25over)) %>%
  mutate(across(-c(zip), as.numeric)) %>%
  relocate(c(`% High School Graduate or Higher`,
             `% Health Insurance`,
             `Median Household Income ($)`), 
             .after = last_col()) %>%
  relocate(`Median Age (Years)`, .before = `Population - Female`)

colnames(economics_social_merged) <- colnames(economics_social_merged) %>%
  str_replace_all("Population - Age", "% Age") %>%
  str_replace_all("Population -", "%")
```
### eTABLE 1: Demographics of overall study population (entire city)

```{r}

citywidenum <- economics_social_by_zip %>%
  dplyr::summarise(across(`Population - Age 0-17`:`Population - Other Race Non-Latinx`, sum),
                   healthinsurance = sum(healthinsuranceest),
                   highschool = sum(highschoolest))

citywidepct <- economics_social_merged %>%
  mutate_at(vars(starts_with("%")), 
                 list(~ weighted.mean(., population))) %>%
  mutate(IQR = round(IQR(`Median Household Income ($)`), 0),
         `Median Household Income ($)` = 
           round(weighted.median(`Median Household Income ($)`, w = population), 0)) %>%
  mutate(ageIQR = round(IQR(`Median Age (Years)`), 0),
         `Median Age (Years)` = 
           round(weighted.median(`Median Age (Years)`, w = population), 0)) %>%
  relocate(ageIQR, .after = `Median Age (Years)`) %>%
  mutate(across(starts_with("%"), round)) %>%
  mutate(population = sum(population)) %>%
  dplyr::select(-c(Year, zip)) %>%
  unique()

citywidenum
citywidepct
```

### TABLE 1: Demographics of vaccination groups

```{r TABLE 1 - alpha group demographics}

economics_social_by_zip <- left_join(economics_social_by_zip,
                                     dplyr::select(groups_tbl, c(zip, vax_group_alpha)))

economics_social_merged <- left_join(economics_social_merged,
                                     dplyr::select(groups_tbl, c(zip, vax_group_alpha)))

table1num_alpha <- economics_social_by_zip %>%
  dplyr::group_by(vax_group_alpha) %>%
  dplyr::summarise(across(`Population - Age 0-17`:`Population - Other Race Non-Latinx`, sum),
                   healthinsurance = sum(healthinsuranceest),
                   highschool = sum(highschoolest))

table1pct_alpha <- economics_social_merged %>%
  dplyr::group_by(vax_group_alpha) %>%
  mutate_at(vars(starts_with("%")), 
                 list(~ weighted.mean(., population))) %>%
  group_by(vax_group_alpha) %>%
  mutate(IQR = round(IQR(`Median Household Income ($)`), 0),
         `Median Household Income ($)` = 
           round(weighted.median(`Median Household Income ($)`, w = population), 0)) %>%
  mutate(ageIQR = round(IQR(`Median Age (Years)`), 0),
         `Median Age (Years)` = 
           round(weighted.median(`Median Age (Years)`, w = population), 0)) %>%
  relocate(ageIQR, .after = `Median Age (Years)`) %>%
  mutate(across(starts_with("%"), round)) %>%
  ungroup() %>%
  dplyr::select(-c(Year, population, zip)) %>%
  unique() %>%
  arrange(vax_group_alpha)

# denominators

popdenominators_alpha <- economics_social_by_zip %>%
  dplyr::group_by(vax_group_alpha) %>%
  dplyr::summarise(population = sum(population), pop25over = sum(pop25over), civiliannoninst = sum(civiliannoninst))

table1_alpha <- left_join(table1num_alpha, table1pct_alpha) %>%
  mutate(Population = popdenominators_alpha$population,
         `Age 0-17` = paste0(`Population - Age 0-17`, " (",
                             `% Age 0-17`, ")"),
         `Age 18-65` = paste0(`Population - Age 18-65`,
                              " (",
                             `% Age 18-65`, ")"),
         `Age 65+` = paste0(`Population - Age 65+`,
                              " (",
                             `% Age 65+`, ")"),
         `Median Age (IQR)` = 
           paste0(`Median Age (Years)`, " (", ageIQR, ")"),
         `Female` = paste0(`Population - Female`,
                              " (",
                             `% Female`, ")"),
         `Male` = paste0(`Population - Male`,
                              " (",
                             `% Male`, ")"),
         `Hispanic` = paste0(`Population - Latinx`,
                              " (",
                             `% Latinx`, ")"),
         `Asian Non-Hispanic` = 
           paste0(`Population - Asian Non-Latinx`, " (",
                  `% Asian Non-Latinx`, ")"),
         `Black Non-Hispanic` = 
           paste0(`Population - Black Non-Latinx`, " (",
                  `% Black Non-Latinx`, ")"),
         `White Non-Hispanic` = 
           paste0(`Population - White Non-Latinx`, " (",
                  `% White Non-Latinx`, ")"),
         `Other Race Non-Hispanic` = 
           paste0(`Population - Other Race Non-Latinx`, " (",
                  `% Other Race Non-Latinx`, ")"),
         `High School Graduate or Higher No. (%)` = 
           paste0(highschool, " (",
                  `% High School Graduate or Higher`, ")"),
         `With Health Insurance No. (%)` = 
           paste0(healthinsurance, " (", `% Health Insurance`, ")"),
         `Median Household Income $ (IQR)` = 
           paste0(`Median Household Income ($)`, " (", IQR, ")")) %>%
  relocate(`Median Household Income $ (IQR)`, .after = last_col()) %>%
  dplyr::select(-c(1:29))

tochi_alpha <- table1num_alpha[,2:13]
rownames(tochi_alpha) <- n_labels_alpha

table1_alpha <- t(table1_alpha) %>%
  cbind(c(NA,
    # age
    chisq.test(tochi_alpha[,1:3])$p.value, NA, NA, 
    #  median age
    kruskal.test(`Median Age (Years)`~vax_group_alpha, data = economics_social_by_zip)$p.value,
    # sex
    chisq.test(tochi_alpha[,4:5])$p.value, NA, 
    # race
    chisq.test(tochi_alpha[,6:10])$p.value, NA, NA, NA, NA, 
    summary(aov(`% High School Graduate or Higher`~vax_group_alpha, data = economics_social_by_zip))[[1]][1,5],
    summary(aov(`% Health Insurance`~vax_group_alpha, data = economics_social_by_zip))[[1]][1,5], 
    kruskal.test(`Median Household Income ($)`~vax_group_alpha, data = economics_social_by_zip)$p.value))

for (i in seq_along(table1_alpha[,4])) {
  if (is.na(table1_alpha[i,4])) {
    table1_alpha[i,4] <- ""
  }
  else if (as.numeric(table1_alpha[i,4]) < 0.001) {
    table1_alpha[i,4] <- "< 0.001"
  }
  else {
    table1_alpha[i,4] <- round(as.numeric(table1_alpha[i,4]), 3)
  }
}

colnames(table1_alpha) <- append(n_labels_alpha, "p")

tochi2_alpha <- tochi_alpha %>%
  mutate(group = n_labels_alpha) %>%
  dplyr::group_by(group) %>%
  mutate(under65 = sum(`Population - Age 0-17`, `Population - Age 18-65`)) %>%
  ungroup() %>%
  dplyr::select(`Population - Age 65+`, under65)

rownames(tochi2_alpha) <- n_labels_alpha

chisq.test(tochi2_alpha)

```

# Vaccination Rollout

### eFIGURE 1a: Visualizations of vaccination groups

#### Cumulative vax

```{r}

cumulativevaxstyle <- list(
  scale_fill_manual(values = graphcolors) ,
  scale_color_manual(values = graphcolors) ,
  scale_shape_manual(values = graphshapes) ,
  scale_linetype_manual(values = linetypes) , 
  scale_x_date(date_breaks = "4 weeks", 
               date_minor_breaks = "1 week", 
               guide = guide_axis(angle = 45),
               date_labels = "%b-%d-%Y",
               expand = c(0.01, 0.01)) ,
  scale_y_continuous(limits = c(0, 100)) ,
  labs(x = "\nWeek", y = "First Doses (% Population)\n", 
       linetype = "Distribution Phase") ,
  theme_bw() ,
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(),
        axis.text=element_text(size=12, 
                               face = "bold"),
        axis.title=element_text(size=12,
                                face = "bold"),
        legend.title = element_text(size = 10,
                                    face = "bold"),
        legend.text = element_text(size = 10),
        legend.key.size = unit(1, "lines")))

cumulativevax_alpha <- left_join(joined_df,
                                 dplyr::select(groups_tbl, c(zip, vax_group_alpha))) %>%
  arrange(desc(vax_group_alpha)) %>%
  filter(week_st >= secondwavepeak, week_st <= deltawave_end) %>%
  ggplot(aes(x = week_st, y = cumulative_pct_first)) +
  geom_vline(
    data = phase_data,
    aes(xintercept = phases, linetype = phase_labels),
    color = "gray50",
    key_glyph = "path", size = 1) +
  geom_line(aes(color = vax_group_alpha, group = zip), alpha = 0.5) +
  geom_point(aes(fill = vax_group_alpha, shape = vax_group_alpha, group = zip), 
             color = "gray20",
             alpha = 0.5,
             size = 2) +
  cumulativevaxstyle +
  labs(color = alpha_group_legend, fill = alpha_group_legend, shape = alpha_group_legend)

cumulativevax_alpha

ggsave(paste0("cumulativevax_alpha", secondwavepeak, "_", deltawave_end, ".png"), cumulativevax_alpha, height = 4, width = 8)

```

# New Cases

### FIGURE 2a: Weekly new cases

```{r}

newcases_alpha <- to_graph_alpha %>%
  dplyr::group_by(vax_group_alpha) %>%
  mutate(caseroll = zoo::rollmean(case_rate_weekly, k, fill = NA)) %>%
  ungroup() %>%
  ggplot(aes(x = week_st, y = caseroll)) +
  aesthetics +
  geom_line(aes(color = vax_group_alpha), 
            size = 1) +
  geom_point(aes(fill = vax_group_alpha, 
                 shape = vax_group_alpha), color = "gray20", size = 3) +
  labs(x = "\nWeek", y = "Weekly New Cases (per 100,000)\n",
    shape = alpha_group_legend, 
    fill = alpha_group_legend, 
    color = alpha_group_legend) +
    geom_text(data = NULL, label = "Alpha", x = mdy("5/5/21"), y = 560) +
  geom_text(data = NULL, label = "Delta", x = mdy("9/15/21"), y = 560)

newcases_alpha

ggsave(paste0("weeklycases_alpha", min(to_graph_alpha$week_st), "_", max(to_graph_alpha$week_st), ".pdf"), newcases_alpha, height = 5, width = 9)

```

# Mortality Rate

### FIGURE 2b Rolling average mortality

```{r}

weeklymortality_alpha <-
  ggplot(data = to_graph_alpha, aes(x = week_st, y = mort_roll)) +
  aesthetics +
  geom_line(aes(color = vax_group_alpha), 
            size = 1) +
  geom_point(aes(fill = vax_group_alpha, 
                 shape = vax_group_alpha), color = "gray20", size = 3) +
  labs(x = "\nWeek", y = "Weekly Deaths (per 100,000)\n",
    color = alpha_group_legend,
    fill = alpha_group_legend,
    shape = alpha_group_legend) +
    geom_text(data = NULL, label = "Alpha", x = mdy("5/5/21"), y = 13.5) +
    geom_text(data = NULL, label = "Delta", x = mdy("9/15/21"), y = 13.5)

weeklymortality_alpha

ggsave(paste0("weeklymortality_alpha", min(to_graph_alpha$week_st), "_", max(to_graph_alpha$week_st), ".pdf"),weeklymortality_alpha, height = 5, width = 9)

# alpha peaks

alphawavedf <- to_graph_alpha %>%
   filter(week_st >= alphawave_st & week_st <= alphawave_end) %>%
  filter(is.na(mort_roll) == FALSE)

paste("low vax peak:", max(filter(alphawavedf, vax_group_alpha == n_labels_alpha[1])$mort_roll))
paste("mid vax peak:", max(filter(alphawavedf, vax_group_alpha == n_labels_alpha[2])$mort_roll))
paste("high vax peak:", max(filter(alphawavedf, vax_group_alpha == n_labels_alpha[3])$mort_roll))

# delta peaks

deltawavedf <- to_graph_alpha %>%
   filter(week_st >= deltawave_st & week_st <= deltawave_end) %>%
  filter(is.na(mort_roll) == FALSE)

paste("low vax peak:", max(filter(deltawavedf, vax_group_alpha == n_labels_alpha[1])$mort_roll))
paste("mid vax peak:", max(filter(deltawavedf, vax_group_alpha == n_labels_alpha[2])$mort_roll))
paste("high vax peak:", max(filter(deltawavedf, vax_group_alpha == n_labels_alpha[3])$mort_roll))

```

## FIGURE 1b: mortality map + Pearson's cor

```{r}

mortalitymapstyle <- list(theme_void(), 
    coord_sf(), 
    scale_fill_distiller(palette = "Reds", trans = "reverse"),
    scale_color_manual(values = mapcolorscustom),
    theme(legend.position = "right", 
        plot.title = element_text(hjust = 0.5),
        legend.title = element_text(size = 12, face = "bold"),
        legend.text = element_text(size = 10),
        legend.key.size = unit(1, "lines")),
  guides(color = guide_legend(override.aes = list(size=4))))

alphamortalitymapdf <- alpha_groups %>%
  left_join(dplyr::select(joined_df, -c(cumulative_pct_first, cumulative_first))) %>%
  filter(week_st >= alphawave_st & week_st <= alphawave_end) %>%
  dplyr::group_by(zip) %>%
  dplyr::summarise(vax_group_alpha = vax_group_alpha, 
            zip = zip, 
            population = population, 
            zip_code_location = zip_code_location,
            cumulative_deaths = sum(deaths_weekly) * 100000/population,
            pct_first_alpha = pct_first_alpha) %>%
  distinct() %>%
  left_join(zips_sf)

x <- alphamortalitymapdf$cumulative_deaths
y <- alphamortalitymapdf$pct_first_alpha
w <- alphamortalitymapdf$population

cor(x, y)
alpha_r <- wtd.cor(x, y, w)

alpha_r[1] <- round(alpha_r[1], 2)

if(alpha_r[4] < 0.001) {
  alpha_r[4] <- "(p < 0.001)"
} else{
  alpha_r[4] <- paste0(c("p = ", round(alpha_r[4], 3)))
}

alphamortalitymap <- alphamortalitymapdf %>%
  ggplot() + 
    geom_sf(aes(geometry = geometry, fill = cumulative_deaths)) +
    geom_sf(data = filter(ME_to_map, week_st >= alphawave_st & 
                               week_st <= alphawave_end),
            alpha = 0.4, shape = 16, size = 2) +
    labs(fill = "Deaths during Alpha Wave") +
  mortalitymapstyle +
  geom_label(x = -88, y = 42,
             label = "test")

alphamortalitymap <- ggdraw(alphamortalitymap) +
  draw_image("rectangle.png", scale = 0.45, x = 1, hjust = 1, halign = 1, valign = 0.9) +
  draw_label(paste("Pearson's correlation:", alpha_r[1], alpha_r[4], sep = " "), hjust = 1, x = 0.98, y = 0.875, size = 11, fontface = "bold")

ggsave("alphawavemortalitymap_dots.pdf", alphamortalitymap, height = 7, width = 7)

# Delta

deltamortalitymapdf <- delta_groups %>%
  left_join(dplyr::select(joined_df, -c(cumulative_pct_first, cumulative_first))) %>%
  filter(week_st >= deltawave_st & week_st <= deltawave_end) %>%
  dplyr::group_by(zip) %>%
  dplyr::summarise(vax_group_delta = vax_group_delta, 
            zip = zip, 
            population = population, 
            zip_code_location = zip_code_location,
            cumulative_deaths = sum(deaths_weekly) * 100000/population,
            pct_first_delta = pct_first_delta) %>%
  distinct() %>%
  left_join(zips_sf)

x <- deltamortalitymapdf$cumulative_deaths
y <- deltamortalitymapdf$pct_first_delta
w <- deltamortalitymapdf$population

cor(x, y)
delta_r <- wtd.cor(x, y, w)

delta_r[1] <- round(delta_r[1], 2)

if(delta_r[4] < 0.001) {
  delta_r[4] <- "(p < 0.001)"
} else{
  delta_r[4] <- paste0(c("p = ", round(delta_r[4], 3)))
}

deltamortalitymap <- deltamortalitymapdf %>%
  ggplot() + 
    geom_sf(aes(geometry = geometry, fill = cumulative_deaths)) +
    geom_sf(data = filter(ME_to_map, week_st >= deltawave_st & 
                               week_st <= deltawave_end),
            alpha = 0.4, shape = 16, size = 2) +
    labs(fill = "Deaths during Delta Wave") +
  mortalitymapstyle +
  geom_label(x = -88, y = 42,
             label = "test")

deltamortalitymap <- ggdraw(deltamortalitymap) +
  draw_image("rectangle.png", scale = 0.45, x = 1, hjust = 1, halign = 1, valign = 0.9) +
  draw_label(paste("Pearson's correlation:", delta_r[1], delta_r[4], sep = " "), hjust = 1, x = 0.98, y = 0.875, size = 11, fontface = "bold")

ggsave("deltawavemortalitymap_dots.pdf", deltamortalitymap, height = 7, width = 7)

```

# Difference-in-Difference

If low group had been vaccinated at same rate as high group

```{r DID dataset}

# Started DID at Phase 1C activation (4 weeks after weekly vaccination trends started to diverge)

alphaDID_stdate <- alpha_grouping_date

alphaDID_st <- to_graph_alpha %>%
  filter(week_st == alpha_grouping_date)

to_did_alpha <- to_graph_alpha %>%
  # difference from t0 (alphaDID_st) in high and low groups
  mutate(
    diff0total = case_when(
      vax_group_alpha == factor(n_labels_alpha)[1] ~ alphaDID_st$deaths_cumulative[1] - deaths_cumulative,
      vax_group_alpha == factor(n_labels_alpha)[n_groups] ~ alphaDID_st$deaths_cumulative[n_groups] - deaths_cumulative)) %>%
  # make it subtractable
  dplyr::group_by(week_st) %>%
  mutate(diff1total = rev(diff0total)) %>%
  ungroup() %>%
  mutate(absdeaths_counterfactual = case_when(
            week_st >= alphaDID_stdate & vax_group_alpha == factor(n_labels_alpha)[1] ~ 
               alphaDID_st$deaths_cumulative[1]-diff1total,
            week_st >= alphaDID_stdate & vax_group_alpha == factor(n_labels_alpha)[n_groups] ~
               alphaDID_st$deaths_cumulative[n_groups]-diff1total)) %>%
  filter(is.na(absdeaths_counterfactual) == FALSE)

```

## FIGURE 2c alpha Cumulative mortality - absolute DID

```{r DID figure}

mortalitycumulative_alpha <- filter(to_graph_alpha, 
                                     vax_group_alpha == n_labels_alpha[1] |
                                       vax_group_alpha == n_labels_alpha[3]) %>%
  filter(week_st >= secondwavepeak, week_st <= deltawave_end) %>%
  ggplot(aes(x = week_st, y = deaths_cumulative)) +
  aesthetics +
  geom_line(aes(color = vax_group_alpha), 
            size = 1) +
  geom_point(aes(fill = vax_group_alpha, 
                 shape = vax_group_alpha), color = "gray20", size = 3) +
  scale_fill_manual(values = c(graphcolors[1], graphcolors[3])) +
  scale_color_manual(values = c(graphcolors[1], graphcolors[3])) +
  scale_shape_manual(values = c(graphshapes[1], graphshapes[3])) +
  labs(
    x = "\nWeek",
    y = "Cumulative Deaths (per 100,000)\n",
    shape = alpha_group_legend,
    color = alpha_group_legend,
    fill = alpha_group_legend) +
  scale_y_continuous(limits = c(0, 300)) +
  geom_text(data = NULL, label = "Alpha", x = mdy("5/5/21"), y = 300) +
  geom_text(data = NULL, label = "Delta", x = mdy("9/15/21"), y = 300)

mortalitycumulativedid_alpha <- mortalitycumulative_alpha +
  # filtered out counterfactuals for low group
  geom_point(data = filter(to_did_alpha, vax_group_alpha == n_labels_alpha[1]), 
             aes(x = week_st, y = absdeaths_counterfactual, fill = "Counterfactual", color = "Counterfactual", shape = "Counterfactual"),
             size = 3) +
  # filtered out counterfactuals for low group
  geom_line(data = filter(to_did_alpha, vax_group_alpha == n_labels_alpha[1]), 
            aes(x = week_st, y = absdeaths_counterfactual, group = vax_group_alpha, color = "Counterfactual"), 
            linetype = "dashed") +
  scale_fill_manual(values = c("#FFFFFF", graphcolors[1], graphcolors[3])) +
  scale_color_manual(values = c("#FF0000", graphcolors[1], graphcolors[3])) +
  scale_shape_manual(values = c(1, graphshapes[1], graphshapes[3])) +
  labs(color = alpha_group_legend, fill = alpha_group_legend, shape = alpha_group_legend) 
  
mortalitycumulativedid_alpha

ggsave(paste0("didcumulativemortality_alpha", min(to_graph_alpha$week_st), "_", max(to_graph_alpha$week_st), ".pdf"), mortalitycumulativedid_alpha, height = 5, width = 9)

```

```{r DID alpha and delta }

lowdid_alpha_delta <- to_did_alpha %>%
  filter(week_st == alphawave_st|week_st == deltawave_end, vax_group_alpha == n_labels_alpha[1])

highdid_alpha_delta <- to_did_alpha %>%
  filter(week_st == alphawave_st|week_st == deltawave_end, vax_group_alpha == n_labels_alpha[3])

lowgroupalphadeltawavedeaths <- ((lowdid_alpha_delta$deaths_cumulative[2] - lowdid_alpha_delta$deaths_cumulative[1])*lowdid_alpha_delta$population/100000)[1]

highgroupalphadeltawavedeaths <- ((highdid_alpha_delta$deaths_cumulative[2] - highdid_alpha_delta$deaths_cumulative[1])*highdid_alpha_delta$population/100000)[1]

lowgroupalphadeltacounterfactual <- ((lowdid_alpha_delta$absdeaths_counterfactual[2] - lowdid_alpha_delta$absdeaths_counterfactual[1])*lowdid_alpha_delta$population/100000)[1]

did_alpha_deltalivessaved <- lowgroupalphadeltawavedeaths - lowgroupalphadeltacounterfactual

totalalphadeltadeaths <- joined_df %>%
  filter(week_st >= alphawave_st & week_st <= deltawave_end) 
totalalphadeltadeaths <- sum(totalalphadeltadeaths$deaths_weekly)

paste("Total alpha + delta wave deaths:", totalalphadeltadeaths)

paste("High group alpha + delta deaths:", highgroupalphadeltawavedeaths)

paste("Low group alpha + delta deaths:", lowgroupalphadeltawavedeaths)

paste("Deaths in lowest vaccinated group in counterfactual scenario:", lowgroupalphadeltacounterfactual)

paste("Lives saved if lowest vaccinated zip codes experienced same trend as highly vaccinated:", did_alpha_deltalivessaved)
```

```{r DID alpha}
lowdid_alpha <- to_did_alpha %>%
  filter(week_st == alphawave_end|week_st == alphawave_st, vax_group_alpha == n_labels_alpha[1])

highdid_alpha <- to_did_alpha %>%
  filter(week_st == alphawave_end|week_st == alphawave_st, vax_group_alpha == n_labels_alpha[3])

lowgroupalphawavedeaths <- ((lowdid_alpha$deaths_cumulative[2] - lowdid_alpha$deaths_cumulative[1])*lowdid_alpha$population/100000)[1]

highgroupalphawavedeaths <- ((highdid_alpha$deaths_cumulative[2] - highdid_alpha$deaths_cumulative[1])*highdid_alpha$population/100000)[1]

lowgroupalphawavecounterfactual <- ((lowdid_alpha$absdeaths_counterfactual[2] - lowdid_alpha$absdeaths_counterfactual[1])*lowdid_alpha$population/100000)[1]

did_alphalivessaved <- lowgroupalphawavedeaths - lowgroupalphawavecounterfactual

totalalphadeaths <- joined_df %>%
  filter(week_st >= alphawave_st & week_st <= alphawave_end) 
totalalphadeaths <- sum(totalalphadeaths$deaths_weekly)

paste("Total alpha wave deaths:", totalalphadeaths)

paste("High group alpha deaths:", highgroupalphawavedeaths)

paste("Low group alpha deaths:", lowgroupalphawavedeaths)

paste("Deaths in lowest vaccinated group in counterfactual scenario:", lowgroupalphawavecounterfactual)

paste("Lives saved if lowest vaccinated zip codes experienced same trend as highly vaccinated:", did_alphalivessaved)

```

```{r DID delta}

lowdid_delta <- to_did_alpha %>%
  filter(week_st == deltawave_end|week_st == deltawave_st, vax_group_alpha == n_labels_alpha[1])

highdid_delta <- to_did_alpha %>%
  filter(week_st == deltawave_end|week_st == deltawave_st, vax_group_alpha == n_labels_alpha[3])

lowgroupdeltawavedeaths <- ((lowdid_delta$deaths_cumulative[2] - lowdid_delta$deaths_cumulative[1])*lowdid_delta$population/100000)[1]

highgroupdeltawavedeaths <- ((highdid_delta$deaths_cumulative[2] - highdid_delta$deaths_cumulative[1])*highdid_delta$population/100000)[1]

lowgroupdeltawavecounterfactual <- ((lowdid_delta$absdeaths_counterfactual[2] - lowdid_delta$absdeaths_counterfactual[1])*lowdid_delta$population/100000)[1]

did_deltalivessaved <- lowgroupdeltawavedeaths - lowgroupdeltawavecounterfactual

totaldeltadeaths <- joined_df %>%
  filter(week_st >= deltawave_st & week_st <= deltawave_end) 
totaldeltadeaths <- sum(totaldeltadeaths$deaths_weekly)

paste("Total delta wave deaths:", totaldeltadeaths)

paste("High group delta deaths:", highgroupdeltawavedeaths)

paste("Low group delta deaths:", lowgroupdeltawavedeaths)

paste("Deaths in lowest vaccinated group in counterfactual scenario:", lowgroupdeltawavecounterfactual)

paste("Lives saved if lowest vaccinated zip codes experienced same trend as highly vaccinated:", did_deltalivessaved)

```

# Model Fitting

## Model 1: Parallel trends

$log(Y_i)-log(pop_i)=\beta_{0i}+\beta_{1i}week+\beta_2wave+\beta_3wave*vaxleveldec$

```{r modeling df dates}

start_alphadf <- secondwavepeak
start_deltadf <- alphawavepeak
chngwave_alpha <- alphawave_st
chngwave_delta <- deltawave_st
# end <- mdy("6/14/21")

btwnwaves_alpha <- interval(start_alphadf, alphawave_st)
btwnwaves_delta <- interval(start_deltadf, deltawave_st)

alpha_int <- interval(alphawave_st, alphawave_end)
delta_int <- interval(deltawave_st, deltawave_end)

chngwavenum_alpha <- (start_alphadf %--% chngwave_alpha) %/% weeks(1) + 1
chngwavenum_delta <- (start_deltadf %--% chngwave_delta) %/% weeks(1) + 1
```

```{r CDPH alpha modeling df}
# Want to know cumulative % of first doses 6 weeks before peak of alpha wave

vaxlevel_zip_alpha <- joined_df %>%
  filter(week_st == alpha_grouping_date & !zip %in% outliers$zip) %>% 
  # deciles 
  mutate(alpha_vaxleveldec = cumulative_pct_first / 10,
         alpha_completeleveldec = cumulative_pct_complete / 10,
         alpha_recoveredleveldec = (cases_cumulative - deaths_cumulative)/population * 10) %>%
  dplyr::select(zip, population, alpha_vaxleveldec, alpha_recoveredleveldec, alpha_completeleveldec)

age_by_zip <- demo_by_zip %>%
  rename(pop65plus = `Population - Age 65+`) %>%
  mutate(dec65plus = pop65plus/population * 10) %>%
  filter(population >= pop_limit) %>%
  dplyr::select(zip, dec65plus)

# alpha

mixedeffectsdf_alpha_zip <- joined_df %>%
  filter(week_st >= start_alphadf) %>%
  # reindex weeks to be since beginning of 3rd wave
  mutate(week = week-min(week),
         wave = case_when(week_st %within% btwnwaves_alpha ~ 0,
                          week_st %within% alpha_int ~ 1,
                          )) %>%
  left_join(vaxlevel_zip_alpha) %>% 
  left_join(age_by_zip) %>%
  dplyr::group_by(wave) %>%
  mutate(wave_week = week - min(week)) %>%
  dplyr::group_by(wave, zip) %>%
  mutate(deaths_wave = max(deaths_cumulative) - min(deaths_cumulative)) %>%
  arrange(week_st) %>%
  dplyr::group_by(zip) %>%
  mutate(vaxleveldeclag = dplyr::lag(cumulative_pct_first, 6)/10) %>%
  ungroup() %>%
  filter(is.na(wave) == FALSE) %>%
  left_join(dplyr::select(alpha_groups, c(zip, vax_group_alpha))) %>%
  mutate(vax_group_alpha = relevel(vax_group_alpha, ref = n_labels_alpha[n_groups]))
```

```{r CDPH delta modeling df}

# Delta

vaxlevel_zip_delta <- joined_df %>%
  filter(week_st == delta_grouping_date & !zip %in% outliers$zip) %>% 
  # deciles 
  mutate(delta_vaxleveldec = cumulative_pct_first / 10,
         delta_completeleveldec = cumulative_pct_complete / 10,
         delta_recoveredleveldec = (cases_cumulative - deaths_cumulative)/population * 10) %>%
  dplyr::select(zip, population, delta_vaxleveldec, delta_recoveredleveldec, delta_completeleveldec)

mixedeffectsdf_delta_zip <- joined_df %>%
  filter(week_st >= start_deltadf) %>%
  # reindex weeks to be since beginning of 3rd wave
  mutate(week = week-min(week),
         wave = case_when(week_st %within% btwnwaves_delta ~ 0,
                          week_st %within% delta_int ~ 1,
                          )) %>%
  left_join(vaxlevel_zip_delta) %>% 
  left_join(age_by_zip) %>%
  dplyr::group_by(wave) %>%
  mutate(wave_week = week - min(week)) %>%
  dplyr::group_by(wave, zip) %>%
  mutate(deaths_wave = max(deaths_cumulative) - min(deaths_cumulative)) %>%
  arrange(week_st) %>%
  dplyr::group_by(zip) %>%
  mutate(vaxleveldeclag = dplyr::lag(cumulative_pct_first, 6)/10) %>%
  ungroup() %>%
  filter(is.na(wave) == FALSE) %>%
  left_join(dplyr::select(delta_groups, c(zip, vax_group_delta))) %>%
  mutate(vax_group_delta = relevel(vax_group_delta, ref = n_labels_delta[n_groups]))

```

### eTABLE 4: Model 1 (Test for parallel trends)

```{r}

# alpha

model1_alpha_zip <- glm(data = filter(mixedeffectsdf_alpha_zip, wave == 0), deaths_weekly ~ week*vax_group_alpha + offset(log(population)), family = poisson(link = "log"))

tab_model(model1_alpha_zip, transform = NULL, show.ci = FALSE, show.se = TRUE)

linearHypothesis(model1_alpha_zip, c("week:vax_group_alphaLeast vaccinated quartile = 0", "week:vax_group_alphaMiddle 25-75% = 0"))


```

## Model 2 Mixed Effects

### TABLE 2 + eTABLE 5 (unadjusted)

```{r}

# Random effects on intercept from zip (starting at different peaks during wave 0)

# alpha (Zip)

model2_alpha_zip <- glmer(data = mixedeffectsdf_alpha_zip, deaths_weekly ~ (1|zip) + week + wave + wave:alpha_vaxleveldec + offset(log(population)), family = poisson(link = "log"))

model2_alpha_zip

# Delta (Zip)

model2_delta_zip <- glmer(data = mixedeffectsdf_delta_zip, deaths_weekly ~ (1|zip) + week + wave + wave:delta_vaxleveldec + offset(log(population)), family = poisson(link = "log"))

model2_delta_zip

```



## Model 3 (with recovered and aging):

$log(Y_i)-log(pop_i)=\beta_{0i}+\beta_{1i}week+\beta_2wave+\beta_3wave*vaxleveldec+\beta_4recoveredleveldec+\beta_5dec65plus$

### Model 3: TABLE 2 + eTABLE 5 (adjusted)

```{r}

# alpha Zip

model3_alpha_zip <- glmer(data = mixedeffectsdf_alpha_zip, deaths_weekly ~ (1|zip) + week + wave + wave:alpha_vaxleveldec + alpha_recoveredleveldec + dec65plus + offset(log(population)), family = poisson(link = "log"))

model3_alpha_zip

# Delta Zip

model3_delta_zip <- glmer(data = mixedeffectsdf_delta_zip, deaths_weekly ~ (1|zip) + week + wave + wave:delta_vaxleveldec + delta_recoveredleveldec + dec65plus + offset(log(population)), family = poisson(link = "log"))

model3_delta_zip

```

```{r models 2 and 3 in tables}

# alpha zip

tab_model(model2_alpha_zip, model3_alpha_zip,
title = "Table 2: Multivariable analysis of risk reduction in deaths from COVID-19, by vaccinations before alpha wave (alpha, zip)")

tab_model(model2_alpha_zip, model3_alpha_zip, transform = NULL, show.ci = FALSE, show.se = TRUE)

paste("Wave IRR with mean vaccination level (Model 2 alpha zip):", (exp(fixef(model2_alpha_zip)[3] + 
      fixef(model2_alpha_zip)[4]*mean(vaxlevel_zip_alpha$alpha_vaxleveldec))))

paste("Week IRR with mean vaccination level (Model 2 alpha zip):", exp(fixef(model2_alpha_zip)[2] + 
      fixef(model2_alpha_zip)[4]*mean(vaxlevel_zip_alpha$alpha_vaxleveldec)))

paste("Wave IRR with mean vaccination level (Model 3 alpha zip):", (exp(fixef(model3_alpha_zip)[3] + 
      fixef(model3_alpha_zip)[6]*mean(vaxlevel_zip_alpha$alpha_vaxleveldec))))

paste("Week IRR with mean vaccination level (Model 3 alpha zip):", exp(fixef(model3_alpha_zip)[2] + 
      fixef(model3_alpha_zip)[6]*mean(vaxlevel_zip_alpha$alpha_vaxleveldec)))

# delta zip

tab_model(model2_delta_zip, model3_delta_zip,
title = "Table 2: Multivariable analysis of risk reduction in deaths from COVID-19, by vaccinations before delta wave (delta, zip)")

tab_model(model2_delta_zip, model3_delta_zip, transform = NULL, show.ci = FALSE, show.se = TRUE)


paste("Wave IRR with mean vaccination level (Model 2 delta zip):", (exp(fixef(model2_delta_zip)[3] + 
      fixef(model2_delta_zip)[4]*mean(vaxlevel_zip_delta$delta_vaxleveldec))))

paste("Week IRR with mean vaccination level (Model 2 delta zip):", exp(fixef(model2_delta_zip)[2] + 
      fixef(model2_delta_zip)[4]*mean(vaxlevel_zip_delta$delta_vaxleveldec)))

paste("Wave IRR with mean vaccination level (Model 3 delta zip):", (exp(fixef(model3_delta_zip)[3] + 
      fixef(model3_delta_zip)[6]*mean(vaxlevel_zip_delta$delta_vaxleveldec))))

paste("Week IRR with mean vaccination level (Model 3 delta zip):", exp(fixef(model3_delta_zip)[2] + 
      fixef(model3_delta_zip)[6]*mean(vaxlevel_zip_delta$delta_vaxleveldec)))

```

### Model 3b (with vax groups) - eTABLE 6: Sensitivity analysis

```{r}

# alpha zip

model3b_alpha_zip <- glmer(data = mixedeffectsdf_alpha_zip, deaths_weekly ~ (1|zip) + week + wave + wave:vax_group_alpha + alpha_recoveredleveldec + dec65plus + offset(log(population)), family = poisson(link = "log"))

# delta zip

model3b_delta_zip <- glmer(data = mixedeffectsdf_delta_zip, deaths_weekly ~ (1|zip) + week + wave + wave:vax_group_delta + delta_recoveredleveldec + dec65plus + offset(log(population)), family = poisson(link = "log"))

tab_model(model3b_alpha_zip, model3b_delta_zip, transform = NULL)

tab_model(model3b_alpha_zip, model3b_delta_zip)

```

vaxleveldec = 10% increase in people with first doses out of entire population; recoveredleveldec = 10% increase in recovered from COVID-19 out of entire population; dec65plus = 10% increase in people over 65 years old out of entire population

## eTABLE 6 Sensitivity analysis - Model 4: Levels of fully vaccinated

```{r}

# alpha zip

model4_alpha_zip <- glmer(data = mixedeffectsdf_alpha_zip, deaths_weekly ~ (1|zip) + week + wave + wave:alpha_completeleveldec + alpha_recoveredleveldec + dec65plus + offset(log(population)), family = poisson(link = "log"))

# delta zip

model4_delta_zip <- glmer(data = mixedeffectsdf_delta_zip, deaths_weekly ~ (1|zip) + week + wave + wave:delta_completeleveldec + delta_recoveredleveldec + dec65plus + offset(log(population)), family = poisson(link = "log"))

tab_model(model4_alpha_zip, model4_delta_zip, transform = NULL, show.ci = FALSE, show.se = TRUE)

tab_model(model4_alpha_zip, model4_delta_zip)

```

# SUPPLEMENT: Census Tract-Level Data



```{r ME data check}

# Check against CDPH data

paste0(c("Deaths with Chicago listed as residence:", 
        as.character(length(filter(ME_covid_deaths,`Residence City` == "CHICAGO" | `Residence City` == "Chicago")$`Case Number`))))

paste0(c("Deaths with Chicago listed as incidence:", 
        as.character(length(filter(ME_covid_deaths,`Incident City` == "CHICAGO" | `Incident City` == "Chicago")$`Case Number`))))

paste0(c("Deaths with Chicago listed as residence or incidence:", 
        as.character(length(filter(ME_covid_deaths,`Incident City` == "CHICAGO" | `Incident City` == "Chicago" | `Residence City` == "CHICAGO" | `Residence City` == "Chicago")$`Case Number`))))

# alpha comparison

ME_covid_deaths_alphaperiod <- filter(ME_covid_deaths_clean, week_st >= secondwavepeak, week_st <= alphawave_end)

paste0(c("Deaths with Chicago listed as incidence with valid address during alpha period:", 
        as.character(length(filter(ME_covid_deaths_alphaperiod,`Incident City` == "CHICAGO" | `Incident City` == "Chicago")$`Case Number`))))

paste0(c("Deaths in CDPH dataset during alpha period:", 
        sum(filter(covid_by_zip, week_st >= secondwavepeak, week_st <= alphawave_end)$`Deaths - Weekly`)))

# Delta comparison 

ME_covid_deaths_deltaperiod <- filter(ME_covid_deaths_clean, week_st >= alphawavepeak, week_st <= deltawave_end)

paste0(c("Deaths with Chicago listed as incidence with valid address during delta period:", 
        as.character(length(filter(ME_covid_deaths_deltaperiod,`Incident City` == "CHICAGO" | `Incident City` == "Chicago")$`Case Number`))))

paste0(c("Deaths in CDPH dataset during delta period:", 
        sum(filter(covid_by_zip, week_st >= alphawavepeak, week_st <= deltawave_end)$`Deaths - Weekly`)))

paste0(c("Missing deaths in ME dataset (not accounting for geocoding issues):", 
        sum(covid_by_zip$`Deaths - Weekly`)-length(filter(ME_covid_deaths,`Incident City` == "CHICAGO" | `Incident City` == "Chicago")$`Case Number`)))

mecoviddeathcheck <- ME_covid_deaths_clean %>%
  mutate(week_st = floor_date(death_date, unit = "weeks", week_start = 7)) %>%
  filter(week_st <= rightdate_cutoff) %>%
  count(week_st, `Incident Zip Code`) %>%
  rename(zip = `Incident Zip Code`)

hospitalcheck <- ME_covid_deaths_clean %>%
  filter(`Incident City` == "Chicago" | `Incident City` == "CHICAGO") %>%
  mutate(location = as.character(location)) %>%
  dplyr::select(location, `Incident Address`) %>%
  st_drop_geometry()

hospitalcheck2 <- hospitalcheck %>%
  count(location) %>%
  left_join(distinct(hospitalcheck, location, .keep_all = TRUE))

# googled addresses with multiple deaths:

# 2544 W Montrose - Kindred Hospital Acute Care (5 deaths)

# 2751 W Winona - Swedish Hospital (7 deaths)

# 2900 N Lake Shore - AMITA Health Saint Joseph Hospital (3 deaths)

# quantify difference between CDPH and ME datasets
CDPH_ME_joined <- covid_by_zip %>%
  filter(zip != "60827" & zip != "60707" & zip != "60602" & zip != "60603" & zip != "60604" & zip != "60606" & zip != "60666") %>%
  filter(week_st <= alphawave_end & week_st > alphawave_st) %>%
  arrange(week_st, zip) %>%
  dplyr::select(c(week_st, zip, `Deaths - Weekly`)) %>%
  rename(CDPH_n = `Deaths - Weekly`) %>%
  mutate(zip = as.double(zip)) %>%
  left_join(mecoviddeathcheck) %>%
  mutate(n = replace_na(n, 0)) %>%
  dplyr::select(-geometry)

paste0(c("Deaths in CDPH dataset:", as.character(sum(CDPH_ME_joined$CDPH_n))))
paste0(c("Deaths in ME dataset with valid incident locations:", as.character(sum(CDPH_ME_joined$n))))

# plot difference between CDPH and ME datasets

CDPH_ME_joined %>%
  mutate(zip = as.character(zip)) %>%
  left_join(zips_sf) %>%
  dplyr::group_by(zip) %>%
  summarise(ME_n = sum(n), CDPH_n = sum(CDPH_n), geometry = geometry) %>%
  unique() %>%
  mutate(diff = CDPH_n-ME_n) %>%
  ggplot() +
  geom_sf(aes(geometry = geometry, fill = diff)) +
  scale_fill_distiller(palette = "RdBu") +
  labs(fill = "CDPH deaths - ME deaths \n (entire alpha wave)") +
  theme_dark()
  
```

```{r zip and tract overlap}

zcta_tracts <- read_csv("ZIP_TRACT_122019.csv") %>%
  rename(GEOID = TRACT, zip = ZIP) %>%
  inner_join(dplyr::select(demo_by_zip, c(zip, population, `Population - Age 65+`))) %>%
  rename(population_zip = population, pop65plus_zip = `Population - Age 65+`) %>%
  filter(!zip %in% outliers$zip) %>%
  # multiplying by overlap of addresses (including residential and business, so that each census tract has a population)
  mutate(population_overlap = population_zip * TOT_RATIO, GEOID = as.character(GEOID),
         pop65plus_tract = pop65plus_zip * TOT_RATIO)

all_tracts <- zcta_tracts %>%
  right_join(dplyr::select(joined_df, c(week_st, zip)))

ME_by_tract <- ME_to_map %>%
  as.data.frame() %>%
  dplyr::select(-geometry) %>%
  count(week_st, GEOID, zip) %>%
  mutate(zip = as.character(zip)) %>%
  right_join(all_tracts) %>%
  mutate(deaths_weekly = replace_na(n, 0),
         overlap_group = paste0(GEOID, "_", zip))

```

```{r ME alpha modeling df}

mixedeffectsdf_alpha_tract <- ME_by_tract %>%
  left_join(dplyr::select(joined_df, week, zip, week_st)) %>%
  filter(week_st >= start_alphadf) %>%
  # reindex weeks to be since beginning of alpha wave
  mutate(week = week-min(week),
         wave = case_when(week_st %within% btwnwaves_alpha ~ 0,
                          week_st %within% alpha_int ~ 1,
                          )) %>%
  left_join(vaxlevel_zip_alpha) %>% 
  left_join(age_by_zip) %>%
  # remove zip population variable and rename population_overlap to make it easier to repeat models on different datasets
  dplyr::select(-population) %>%
  rename(population = population_overlap) %>%
  dplyr::group_by(wave) %>%
  mutate(wave_week = week - min(week)) %>%
  dplyr::group_by(wave, zip) %>%
  mutate(deaths_wave = sum(deaths_weekly)) %>%
  arrange(week_st) %>%
  filter(is.na(wave) == FALSE) %>%
  left_join(dplyr::select(alpha_groups, c(zip, vax_group_alpha))) %>%
  mutate(vax_group_alpha = relevel(vax_group_alpha, ref = n_labels_alpha[n_groups]))
  
```

```{r ME delta modeling df}

mixedeffectsdf_delta_tract <- ME_by_tract %>%
  left_join(dplyr::select(joined_df, week, zip, week_st)) %>%
  filter(week_st >= start_deltadf) %>%
  # reindex weeks to be since beginning of delta wave
  mutate(week = week-min(week),
         wave = case_when(week_st %within% btwnwaves_delta ~ 0,
                          week_st %within% delta_int ~ 1,
                          )) %>%
  left_join(vaxlevel_zip_delta) %>% 
  left_join(age_by_zip) %>%
  # remove zip population variable and rename population_overlap to make it easier to repeat models on different datasets
  dplyr::select(-population) %>%
  rename(population = population_overlap) %>%
  dplyr::group_by(wave) %>%
  mutate(wave_week = week - min(week)) %>%
  dplyr::group_by(wave, zip) %>%
  mutate(deaths_wave = sum(deaths_weekly)) %>%
  arrange(week_st) %>%
  filter(is.na(wave) == FALSE) %>%
  left_join(dplyr::select(delta_groups, c(zip, vax_group_delta))) %>%
  mutate(vax_group_delta = relevel(vax_group_delta, ref = n_labels_delta[n_groups]))
  
```

## alpha tract (models 2 and 3)

```{r}

# Random effects on intercept from zip (starting at different peaks during wave 0)

# alpha (tract)

model2_alpha_tract <- glmer(data = mixedeffectsdf_alpha_tract, deaths_weekly ~ (1|overlap_group) + week + wave + wave:alpha_vaxleveldec + offset(log(population)), family = poisson(link = "log"))

model3_alpha_tract <- glmer(data = mixedeffectsdf_alpha_tract, deaths_weekly ~ (1|overlap_group) + week + wave + wave:alpha_vaxleveldec + alpha_recoveredleveldec + dec65plus + offset(log(population)), family = poisson(link = "log"))

tab_model(model2_alpha_tract, model3_alpha_tract, transform = NULL, show.ci = FALSE, show.se = TRUE)

tab_model(model2_alpha_tract, model3_alpha_tract, transform = "exp")

```

## Delta (models 2 and 3)

```{r}

# Delta (tract)

model2_delta_tract <- glmer(data = mixedeffectsdf_delta_tract, deaths_weekly ~ (1|overlap_group) + week + wave + wave:delta_vaxleveldec + offset(log(population)), family = poisson(link = "log"))

model3_delta_tract <- glmer(data = mixedeffectsdf_delta_tract, deaths_weekly ~ (1|overlap_group) + week + wave + wave:delta_vaxleveldec + delta_recoveredleveldec + dec65plus + offset(log(population)), family = poisson(link = "log"))

tab_model(model2_delta_tract, model3_delta_tract, transform = NULL, show.ci = FALSE, show.se = TRUE)

```



```
