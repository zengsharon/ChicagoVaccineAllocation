---
title: "Consequences of vaccine allocation inequity in Chicago"
author: Sharon Zeng
output: 
  html_document:
    toc: true
    toc_float: true
--- 

```{r global_options, include=FALSE, cache = FALSE}
library(knitr)
library(kableExtra)
library(ggpubr)
library(sf)
library(tigris)
library(viridis)
library(tidycensus)
library(lubridate)
library(ggstance)
library(plotly)
library(Rmisc)
library(tidyverse)
library(RColorBrewer)
library(ggsci)
library(zoo)
library(rcartocolor)
library(gridExtra)
library(grid)
library(lattice)
library(latticeExtra)
library(MASS)
library(DescTools)
library(lme4)
library(sjPlot)
library(ggeffects)
library(parameters)
library(webshot)
library(cluster)
library(ClusterR)
library(janitor)
library(spatstat)
library(openxlsx)
library(performance)
library(ggrepel)
library(ggsflabel)
library(tableone)
library(Hmisc)
library(weights)
library(car)
library(ggmap)
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE, fig.height = 5, fig.width = 9)
options(tigris_use_cache = TRUE, tinytex.verbose = TRUE)
```

```{r zip geometry}
#zip_codes <- zctas(cb = TRUE, class = "sf")

#save(file = "zip_code_data.R", zip_codes)

load("zip_code_data.R")

zips_sf <- zip_codes %>%
  dplyr:: select(zip = ZCTA5CE10, geometry) %>%
  mutate(zip = as.character(zip))
```

Data from the Chicago Department of Public Health (CDPH) 

* [Vaccine source data](https://data.cityofchicago.org/Health-Human-Services/COVID-19-Vaccinations-by-ZIP-Code/553k-3xzc) 
* [Mortality source data](https://data.cityofchicago.org/Health-Human-Services/COVID-19-Cases-Tests-and-Deaths-by-ZIP-Code/yhhz-zm2v)
* [Demographics in zip codes (U.S. Census Bureau, 2019 ACS 5-year estimates)](https://data.cityofchicago.org/Health-Human-Services/Chicago-Population-Counts/85cm-7uqa)
* [More ZCTA demographics (U.S. Census Bureau, 2019 ACS 5-year estimates - Economic and Social Characteristics)](https://www.census.gov/acs/www/data/data-tables-and-tools/data-profiles/)

Last updated at `r format(Sys.Date(),'%A, %B %d')` at `r format(Sys.time(), '%I:%M %p')` CST. 

```{r demographic data}

demo_by_zip <- read_csv("https://data.cityofchicago.org/api/views/85cm-7uqa/rows.csv?accessType=DOWNLOAD") %>%
  filter(`Geography Type` != "Citywide", Year == 2019) %>%
  rename(zip = Geography, population = `Population - Total`) %>%
  mutate(zip = as.character(zip)) %>%
  dplyr::select(-`Geography Type`, -`Record ID`)

```


```{r covid data}
covid_by_zip <-
  read_csv(
    "COVID-19_Cases_Tests__and_Deaths_by_ZIP_Code_090821.csv"
  ) %>%
  mutate(
    zip = as.character(`ZIP Code`),
    week_st = mdy(`Week Start`),
    week_end = mdy(`Week End`)
  ) %>%
  mutate(int = interval(week_st, week_end)) %>%
  #get weeks since beginning of pandemic (1 = first week of pandemic in US/starts indexing at 1)
  mutate(week = (min(week_st) %--% week_st) %/% weeks(1) + 1) %>%
  dplyr:: select(-`Week Number`,-`ZIP Code`,-`Row ID`)

write.csv(covid_by_zip, "covid_by_zip.csv")

# use 2019 population estimates
covid_by_zip <- demo_by_zip %>%
  dplyr::select(zip, population) %>%
  rename(population2019 = population) %>%
  right_join(covid_by_zip) %>%
  mutate(`Case Rate - Weekly` = `Cases - Weekly`*100000/population2019,
         `Case Rate - Cumulative` = `Cases - Cumulative`*100000/population2019,
         `Test Rate - Weekly` = `Tests - Weekly`*100000/population2019,
         `Test Rate - Cumulative` = `Tests - Cumulative`*100000/population2019,
         `Percent Tested Positive - Weekly` = `Tests - Weekly`*`Population`/population2019,
         `Percent Tested Positive - Cumulative` = `Tests - Cumulative`*`Population`/population2019,
         `Death Rate - Weekly` = `Deaths - Weekly`*100000/population2019,
         `Death Rate - Cumulative` = `Deaths - Cumulative`*100000/population2019) %>%
  dplyr::select(-`Population`) %>%
  rename(population = population2019)
  
```

```{r vaccination data}
vax_by_zip <-
  read_csv("COVID-19_Vaccinations_by_ZIP_Code_090821.csv") %>%
  mutate(zip = as.character(`Zip Code`),
         date = mdy(Date)) %>%
  mutate(week_st = floor_date(date, unit = "weeks", week_start = 7)) %>%
  #get week totals from reported daily numbers
  dplyr::group_by(week_st, zip) %>%
  mutate(
    cumulative_doses_weekly = max(`Total Doses - Cumulative`),
    cumulative_first_weekly = max(`1st Dose - Cumulative`),
    cumulative_complete_weekly = max(`Vaccine Series Completed - Cumulative`),
    cumulative_pct_first = max(`1st Dose - Percent Population`)*100,
    cumulative_pct_complete = max(`Vaccine Series Completed  - Percent Population`)*100,
    doses_weekly = sum(`Total Doses - Daily`),
    first_weekly = sum(`1st Dose - Daily`),
    complete_weekly = sum(`Vaccine Series Completed - Daily`)) %>%
    ungroup()

write.csv(vax_by_zip, "vax_by_zip.csv")

vax_by_zip <- vax_by_zip %>%
  #only keep 1 row per week
  dplyr:: select(zip, week_st, cumulative_doses_weekly, cumulative_first_weekly, cumulative_complete_weekly, cumulative_pct_first, cumulative_pct_complete, doses_weekly, first_weekly, `1st Dose - Cumulative`, `Population`) %>%
  filter(`1st Dose - Cumulative`== cumulative_first_weekly) %>%
  dplyr:: select(-`1st Dose - Cumulative`) %>%
  distinct() %>%
  rename(population = `Population`) %>%
  arrange(week_st, zip) %>%
  mutate(population = case_when(zip == "60827" ~ 28483,
                                zip == "60707" ~ 43093,
                                TRUE ~ as.numeric(population)))

#define rollout phases
vax_by_zip <- vax_by_zip %>%
  mutate(
    phase = case_when(
      week_st < mdy("01/25/2021") ~ "1A",
      week_st >= mdy("01/25/2021") & week_st < mdy("03/29/2021") ~ "1B",
      week_st >= mdy("03/29/2021") & week_st < mdy("04/19/2021") ~ "1C", 
      week_st >= mdy("04/19/2021") ~ "2"))
```
 
```{r merge data}
# #merge datasets, keeping all rows from covid data (because vaccinations started later)
# 
merged_df <-  left_join(covid_by_zip, vax_by_zip) %>%
    relocate(week, zip, week_st, week_end) %>%
    dplyr:: select(-`Week Start`,-`Week End`) %>%
    arrange(week_st, zip)
 
  #renaming stuff
colnames(merged_df) <-
    str_replace_all(colnames(merged_df), " - ", " ") %>%
    str_replace_all(" ", "_") %>%
    str_to_lower() %>%
    str_replace_all("1st", "first") %>%
    str_replace_all("percent", "pct") %>%
    str_replace_all("daily", "weekly") %>%
    str_replace_all("__", "_")
 
merged_df <- merged_df %>%
    dplyr::group_by(zip, week) %>%
    #first_dose_rate = number of people starting vaccination series/100000 population
    mutate(
      pct_complete_present = max(cumulative_pct_complete),
      pct_first_present = max(cumulative_pct_first),
      first_dose_rate = first_weekly * 100000 / population)%>%
    #remove rows with missing/not reported zip codes (907 cases cumulatively)
    filter(is.na(zip) == FALSE) %>%
    ungroup()
 
write.csv(merged_df, "cases_vaccinations_weekly.csv", row.names = FALSE, na = "NA")
  
```

```{r parameters for graphing}

max_date <- max(merged_df$week_st)

# Phase 1A: 12/15/20
# Phase 1B: 1/25/21
# Phase 1C: 3/29/21
# Phase 2: 4/19/21
phases <-
  mdy(c("12/15/20", "1/12/21", "01/25/21", "03/29/21", "04/19/21"))
phase_labels <- factor(
  c(
    "Phase 1A begins",
    "4 weeks after Phase 1A",
    "Phase 1B begins",
    "Phase 1C begins",
    "Phase 2 begins"
  ),
  levels = c("Phase 1A begins",
    "4 weeks after Phase 1A",
    "Phase 1B begins",
    "Phase 1C begins",
    "Phase 2 begins"))
phase_data <- data.frame(phase_labels, phases)

pop_limit <- 10000

# start of x-axis
date_cutoff <- mdy("8/9/20")

secondwavepeak <- mdy("12/13/20")

# date to group zip codes by, if grouping by only 1 date
grouping_date <- mdy("3/28/21")
grouping_date_name <- "Grouped by relative level of 1st doses 6 weeks before peak of 3rd wave (3/28/21)"
group_legend <- "% of Population with First Doses"

thirdwave_st <- mdy("3/28/21")
thirdwave_end <- mdy("6/13/21")
secondwave_st <- mdy("8/9/20")

joined_df <- merged_df %>%
  filter(zip != "60827" & zip != "60707") %>%
  filter(week_st <= thirdwave_end) %>%
  filter(population > pop_limit)

# protect_chicago_plus <- read_csv("protect_chicago_plus.csv") %>%
#   mutate(zip = as.character(Zip))
```

```{r clustering}

n_groups <- 3

# change manually
tocluster <- joined_df %>%
  filter(week_st == grouping_date, population > pop_limit) %>%
  dplyr::select(zip, cumulative_pct_first) %>%
  arrange(cumulative_pct_first) %>%
  mutate(rank = row_number()) %>%
  mutate(vax_group = case_when(
    rank <= 13 ~ "[17.8, 26.9]",
    rank >= 39 ~ "[39.9, 49.3]",
    TRUE ~ "[27.6, 39.4]")) %>%
  mutate(vax_group = factor(vax_group, 
                            levels = c("[17.8, 26.9]", 
                                       "[27.6, 39.4]", 
                                       "[39.9, 49.3]"))) %>%
  dplyr::select(-rank)

n_labels <- levels(tocluster$vax_group)

groups <- joined_df %>%
  filter(week_st == grouping_date) %>%
  right_join(tocluster) %>%
  dplyr::summarise(vax_group = factor(vax_group, levels = n_labels),
            cumulative_first_weekly = cumulative_first_weekly,
            cumulative_pct_first = cumulative_pct_first, 
            zip = zip, 
            population = population, 
            # cluster_mean = cluster_mean, 
            zip_code_location = zip_code_location) %>%
  arrange(vax_group, cumulative_pct_first)

groupsabbr <- groups %>%
  dplyr::select(vax_group, zip)

groups %>%
  dplyr::group_by(vax_group) %>%
  dplyr::summarise(population = sum(population))

groupsovertime <- joined_df %>%
  filter(week_st == thirdwave_end, population > pop_limit) %>%
  dplyr::select(zip, cumulative_pct_first) %>%
  arrange(cumulative_pct_first) %>%
  mutate(rank = row_number()) %>%
  mutate(end_group = case_when(
    rank <= 13 ~ "Lowest quartile",
    rank >= 39 ~ "Highest quartile",
    TRUE ~ "Middle 25-75%")) %>%
  rename(pct_spring_end = cumulative_pct_first) %>%
  dplyr::select(-rank) %>%
  right_join(tocluster) %>%
  arrange(cumulative_pct_first) %>%
  relocate(c(cumulative_pct_first, vax_group), .before = pct_spring_end)

```

```{r dataset for graphing}

# weeks to roll average over
k <- 5

to_graph <- groupsabbr %>%
  left_join(joined_df) %>%
  mutate(vax_group = factor(vax_group, levels = n_labels)) %>%
  filter(week_st >= date_cutoff, week_st <= thirdwave_end) %>%
  arrange(vax_group, week_st) %>%
  dplyr::group_by(week_st, week, vax_group) %>%
  dplyr::summarise(
    deathratesd = sqrt(wtd.var(death_rate_weekly, population)),
    death_rate_weekly = weighted.mean(death_rate_weekly, population),
    caseratesd = sqrt(wtd.var(case_rate_weekly, population)),
    case_rate_weekly = weighted.mean(case_rate_weekly, population),
    first_dose_weekly = sum(first_weekly) * 100000 / sum(population),
    deathscumulativesd = sqrt(wtd.var(death_rate_cumulative, population)),
    deaths_cumulative = weighted.mean(death_rate_cumulative, population),
    first_dose_cumulative = sum(cumulative_first_weekly),
    cumulative_pct_first = weighted.mean(cumulative_pct_first*100, population),
    population = sum(population)) %>%
    #rolling average mortality rate over k weeks)
  dplyr::group_by(vax_group) %>%
  mutate(mort_roll = zoo::rollmean(death_rate_weekly, k, fill = NA)) %>%
  ungroup()
```

```{r n groups and graphing aesthetics}

graphcolors <- pal_npg("nrc")(n_groups)
# %>%
#   rev()
# graphcolors <- c("#BFD2F4", "#608FE2", "#004CD1")

graphcolors[2] <- "#3fc2e2ff"

mapcolorsblues <- brewer.pal(n_groups, "Blues")
mapcolorsblues[n_groups+1] <- "#A4A4A4"

mapcolorscustom <- graphcolors
mapcolorscustom[n_groups+1] <- "#A4A4A4"

graphshapes <- c(21, 24, 22, 23, 25)[1:n_groups]

linetypes <- c("longdash", "dotdash", "dotted", "dashed", "twodash")

# ggplot layers that get reused a lot

aesthetics <- list(
  geom_vline(data = phase_data, aes(xintercept = phases, 
                                    linetype = phase_labels), 
             color = "gray50",
             key_glyph = "path", 
             size = 1),
  geom_line(aes(color = vax_group), 
            size = 1),  
  # geom_vline(xintercept = grouping_date, color = "black", alpha = 0.5),
  geom_point(aes(fill = vax_group, 
                 shape = vax_group), color = "gray20", size = 3),
  scale_fill_manual(values = graphcolors),
  scale_color_manual(values = graphcolors),
  scale_shape_manual(values = graphshapes),
  scale_linetype_manual(values = linetypes), 
  scale_x_date(date_breaks = "4 weeks", 
               date_minor_breaks = "1 week", 
               guide = guide_axis(angle = 45),
               date_labels = "%b-%d-%Y",
               expand = c(0.01, 0.01)),
  labs(shape = group_legend, 
       fill = group_legend, 
       color = group_legend, 
       linetype = "Distribution Phase"),
    theme_bw() +
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(), 
        axis.text=element_text(size=12, 
                               face = "bold"),
        axis.title=element_text(size=14,
                                face = "bold"),
        legend.title = element_text(size = 12,
                                    face = "bold"),
        legend.text = element_text(size = 12),
        legend.key.size = unit(1, "lines")))

studyperiod <- paste(date_cutoff, max(to_graph$week_st), sep = "_")
```

\newpage

# Groups

## Histogram of groups

```{r grouping hist check}
groupinghist <- groups %>%
  mutate(vax_group = factor(vax_group, 
                            levels = n_labels)) %>%
  ggplot(aes(cumulative_pct_first, 
             fill = vax_group)) +
    geom_histogram(color = "black") +
  scale_fill_manual(values = graphcolors) +
  labs(fill = group_legend, 
       y = "Number of Zip Codes\n", 
       x = "\n% of Population with First Doses") +
  theme_bw() +
  theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(), 
        panel.grid.major.y = element_line(color = "gray20")) +
  scale_y_continuous(expand =  expansion(add = c(0, 0.5)),
                     breaks = seq(0, 7, 1)) +
  scale_x_continuous(limits = c(0, 50), 
                     expand = c(0, 0)) +
  theme(axis.text=element_text(size=20, 
                               face = "bold"),
        axis.title=element_text(size=20,
                                face = "bold"),
        legend.title = element_text(size = 16,
                                    face = "bold"),
        legend.text = element_text(size = 16),
        legend.key.size = unit(2, "lines"))

groupinghist

ggsave("groupinghist.png", groupinghist, height = 7, width = 12)
```

## Table of groups

```{r table of groups}

st1 <- groups[,1:5] %>%
    rename(`Vaccination Group` = vax_group,
           `First Doses by 3/28/21` = cumulative_first_weekly,
         `% First Doses` = cumulative_pct_first,
         `ZIP` = zip,
         `Population` = population)
  
kable(st1, col.names = c("Group", "Number of First Doses", "% First Doses", "ZIP Code", "Population"),
      caption = "Zip codes included in analysis") %>%
    kable_styling(latex_options = "striped")

write.xlsx(st1, "supptable1.xlsx", row.names = FALSE)
```

## Table of outliers

```{r outliers}
st2 <- merged_df %>%
  filter(week_st == grouping_date) %>%
  filter(population <= pop_limit | zip == "60827" | zip == "60707") %>%
  dplyr:: select(cumulative_first_weekly, cumulative_pct_first, zip, population) %>%
  mutate(group = "Outliers",
         population = case_when(zip == "60827" | zip == "60707" ~ NA_real_,
                                TRUE ~ as.numeric(population))) %>%
  relocate(group) %>%
  rename(`Vaccination Group` = group,
         `Number of First Doses` = cumulative_first_weekly,
         `% First Doses on 3/28/21` = cumulative_pct_first,
         `ZIP` = zip,
         `Population` = population)

kable(st2, col.names = c("Group", "Number of First Doses", "% First Doses", "ZIP Code", "Population")) %>%
  kable_styling(latex_options = "striped")

write.xlsx(st2, "supptable2.xlsx", row.names = FALSE, na = "NA")

```

## Maps of vaccinations and groups

```{r grouping maps}

tomap <- merged_df %>%
  filter(population < pop_limit) %>%
  mutate(vax_group = paste("Suppressed (pop <", pop_limit, ")")) %>%
  dplyr:: select(vax_group, zip, population, zip_code_location) %>%
  distinct() %>%
  full_join(groups) %>%
  left_join(zips_sf) %>%
  mutate(vax_group = factor(vax_group, levels = append(n_labels, paste("Suppressed (pop <", pop_limit, ")"))))

vax_map <- ggplot() + 
    geom_sf(data = tomap, aes(geometry = geometry, fill = cumulative_pct_first)) +
    geom_sf_text_repel(data = filter(tomap, population >= pop_limit),
                               aes(label = zip, geometry = geometry),
                       size = 3,
                       # fontface = "bold",
                       nudge_x = 0,
                       nudge_y = 0,
                       point.size = NA,
                       box.padding = 0.1,
                       min.segment.length = 0.1,
                       max.overlaps = Inf) +
    theme_void() + coord_sf() + 
    scale_fill_distiller(trans = "reverse", limits = c(max(tomap$cumulative_pct_first), 0)) +
    scale_color_manual(values = mapcolorscustom) +
    labs(fill = group_legend, title = "Vaccinations", color = "Vaccination Group") +
    theme(legend.position = "right", 
        plot.title = element_text(hjust = 0.5),
        legend.title = element_text(size = 12, face = "bold"),
        legend.text = element_text(size = 12),
        legend.key.size = unit(1, "lines")) +
  guides(color = guide_legend(override.aes = list(size=4)))

vax_map

ggsave("vaxmap.png", vax_map, height = 7, width = 7)

grouping_map <- ggplot() + 
    geom_sf(data = tomap, aes(geometry = geometry, fill = vax_group)) +
    geom_sf_text_repel(data = filter(tomap, population > pop_limit),
                       aes(geometry = geometry, label = zip),
                       size = 3,
                       # fontface = "bold",
                       nudge_x = 0,
                       nudge_y = 0,
                       point.size = NA,
                       box.padding = 0.1,
                       min.segment.length = 0.1,
                       max.overlaps = Inf) +
    theme_void() + coord_sf() + 
    scale_fill_manual(values = mapcolorscustom) +
    labs(fill = group_legend, title = "Distribution of Vaccination Groups", color = "Vaccination Group") +
    theme(legend.position = "right", 
        plot.title = element_text(hjust = 0.5),
        legend.title = element_text(size = 12, face = "bold"),
        legend.text = element_text(size = 12),
        legend.key.size = unit(1, "lines")) +
  guides(color = guide_legend(override.aes = list(size=4)))

grouping_map

ggsave("groupingmap.png", grouping_map, height = 7, width = 7)

```

## Table 1: Demographics of Vaccination Groups

```{r table 1}

demo_by_zip <- read_csv("https://data.cityofchicago.org/api/views/85cm-7uqa/rows.csv?accessType=DOWNLOAD") %>%
  filter(`Geography Type` != "Citywide", Year == 2019) %>%
  rename(zip = Geography, population = `Population - Total`) %>%
  mutate(zip = as.character(zip)) %>%
  dplyr::select(-`Geography Type`, -`Record ID`) %>%
  mutate(`Population - Age 18-65` = `Population - Age 18+` - `Population - Age 65+`) %>%
  dplyr::select(!`Population - Age 18-29`:`Population - Age 18+`) %>%
  relocate(`Population - Age 18-65`, .after = `Population - Age 0-17`)

economics_social_by_zip <- read_csv("economic_characteristics_ACS.csv") %>%
  left_join(read_csv("social_characteristics_ACS.csv")) %>%
  dplyr::select(`Geographic Area Name`,
                `Estimate!!INCOME AND BENEFITS (IN 2019 INFLATION-ADJUSTED DOLLARS)!!Total households!!Median household income (dollars)`,
                `Percent!!HEALTH INSURANCE COVERAGE!!Civilian noninstitutionalized population!!With health insurance coverage`,
                `Estimate!!HEALTH INSURANCE COVERAGE!!Civilian noninstitutionalized population!!With health insurance coverage`,
                `Estimate!!HEALTH INSURANCE COVERAGE!!Civilian noninstitutionalized population`,
                `Percent!!EDUCATIONAL ATTAINMENT!!Population 25 years and over!!High school graduate or higher`,
                `Estimate!!EDUCATIONAL ATTAINMENT!!Population 25 years and over!!High school graduate or higher`,
                `Estimate!!EDUCATIONAL ATTAINMENT!!Population 25 years and over`) %>%
  separate(`Geographic Area Name`, 
           into = c(NA, "zip")) %>%
  rename(`Median Household Income ($)` = 
           `Estimate!!INCOME AND BENEFITS (IN 2019 INFLATION-ADJUSTED DOLLARS)!!Total households!!Median household income (dollars)`,
         `% Health Insurance` = 
           `Percent!!HEALTH INSURANCE COVERAGE!!Civilian noninstitutionalized population!!With health insurance coverage`,
         healthinsuranceest = 
           `Estimate!!HEALTH INSURANCE COVERAGE!!Civilian noninstitutionalized population!!With health insurance coverage`,
         civiliannoninst = 
           `Estimate!!HEALTH INSURANCE COVERAGE!!Civilian noninstitutionalized population`,
         `% High School Graduate or Higher` = 
           `Percent!!EDUCATIONAL ATTAINMENT!!Population 25 years and over!!High school graduate or higher`,
         highschoolest = 
           `Estimate!!EDUCATIONAL ATTAINMENT!!Population 25 years and over!!High school graduate or higher`,
         pop25over = 
           `Estimate!!EDUCATIONAL ATTAINMENT!!Population 25 years and over`) %>%
  right_join(groupsabbr) %>%
  left_join(demo_by_zip)

economics_social_merged <- economics_social_by_zip %>%
  mutate_at(vars(starts_with("Population - ")), 
                 list(~ ./ population * 100)) %>%
  dplyr::select(-c(healthinsuranceest, highschoolest, civiliannoninst, pop25over)) %>%
  left_join(groupsabbr) %>%
  mutate(across(-c(vax_group, zip), as.numeric)) %>%
  relocate(c(`% High School Graduate or Higher`,
             `% Health Insurance`,
             `Median Household Income ($)`), 
             .after = last_col())

colnames(economics_social_merged) <- colnames(economics_social_merged) %>%
  str_replace_all("Population - Age", "% Age") %>%
  str_replace_all("Population -", "%")

citywidenum <- economics_social_by_zip %>%
  dplyr::summarise(across(`Population - Age 0-17`:`Population - Other Race Non-Latinx`, sum),
                   healthinsurance = sum(healthinsuranceest),
                   highschool = sum(highschoolest))

citywidepct <- economics_social_merged %>%
  mutate_at(vars(starts_with("%")), 
                 list(~ weighted.mean(., population))) %>%
  mutate(IQR = round(IQR(`Median Household Income ($)`), 0),
         `Median Household Income ($)` = 
           round(weighted.median(`Median Household Income ($)`, w = population), 0)) %>%
  mutate(across(starts_with("%"), round)) %>%
  mutate(population = sum(population)) %>%
  dplyr::select(-c(Year, zip, vax_group)) %>%
  unique()

table1num <- economics_social_by_zip %>%
  dplyr::group_by(vax_group) %>%
  dplyr::summarise(across(`Population - Age 0-17`:`Population - Other Race Non-Latinx`, sum),
                   healthinsurance = sum(healthinsuranceest),
                   highschool = sum(highschoolest))

table1pct <- economics_social_merged %>%
  dplyr::group_by(vax_group) %>%
  mutate_at(vars(starts_with("%")), 
                 list(~ weighted.mean(., population))) %>%
  group_by(vax_group) %>%
  mutate(IQR = round(IQR(`Median Household Income ($)`), 0),
         `Median Household Income ($)` = 
           round(weighted.median(`Median Household Income ($)`, w = population), 0)) %>%
  mutate(across(starts_with("%"), round)) %>%
  ungroup() %>%
  dplyr::select(-c(Year, population, zip)) %>%
  unique() %>%
  arrange(vax_group)

table1 <- left_join(table1num, table1pct) %>%
  mutate(`Age 0-17` = paste0(`Population - Age 0-17`, " (",
                             `% Age 0-17`, ")"),
         `Age 18-65` = paste0(`Population - Age 18-65`,
                              " (",
                             `% Age 18-65`, ")"),
         `Age 65+` = paste0(`Population - Age 65+`,
                              " (",
                             `% Age 65+`, ")"),
         `Female` = paste0(`Population - Female`,
                              " (",
                             `% Female`, ")"),
         `Male` = paste0(`Population - Male`,
                              " (",
                             `% Male`, ")"),
         `Latinx` = paste0(`Population - Latinx`,
                              " (",
                             `% Latinx`, ")"),
         `Asian Non-Latinx` = 
           paste0(`Population - Asian Non-Latinx`, " (",
                  `% Asian Non-Latinx`, ")"),
         `Black Non-Latinx` = 
           paste0(`Population - Black Non-Latinx`, " (",
                  `% Black Non-Latinx`, ")"),
         `White Non-Latinx` = 
           paste0(`Population - White Non-Latinx`, " (",
                  `% White Non-Latinx`, ")"),
         `Other Race Non-Latinx` = 
           paste0(`Population - Other Race Non-Latinx`, " (",
                  `% Other Race Non-Latinx`, ")"),
         `High School Graduate or Higher No. (%)` = 
           paste0(highschool, " (",
                  `% High School Graduate or Higher`, ")"),
         `With Health Insurance No. (%)` = 
           paste0(healthinsurance, " (", `% Health Insurance`, ")"),
         `Median Household Income $ (IQR)` = 
           paste0(`Median Household Income ($)`, " (", IQR, ")")) %>%
  relocate(`Median Household Income $ (IQR)`, .after = last_col()) %>%
  dplyr::select(-c(1:27))

tochi <- table1pct %>%
  dplyr::select(-vax_group)
tochi <- t(tochi)[1:10,]
colnames(tochi) <- n_labels

table1 <- t(table1) %>%
  cbind(c(
    # age
    chisq.test(tochi[1:3,])$p.value, NA, NA, 
    # sex
    chisq.test(tochi[4:5,])$p.value, NA, 
    # race
    chisq.test(tochi[6:10,])$p.value, NA, NA, NA, NA, 
    summary(aov(`% High School Graduate or Higher`~vax_group, data = economics_social_by_zip))[[1]][1,5],
    summary(aov(`% Health Insurance`~vax_group, data = economics_social_by_zip))[[1]][1,5], 
    kruskal.test(`Median Household Income ($)`~vax_group, data = economics_social_by_zip)$p.value))

for (i in seq_along(table1[,4])) {
  if (is.na(table1[i,4])) {
    table1[i,4] <- ""
  }
  else if (as.numeric(table1[i,4]) < 0.001) {
    table1[i,4] <- "< 0.001"
  }
  else {
    table1[i,4] <- round(as.numeric(table1[i,4]), 3)
  }
}

colnames(table1) <- append(cell_spec(n_labels, background = alpha(graphcolors, 0.5)), "p")

row.names(table1)[11:13] <- paste0(row.names(table1)[11:13],
                                footnote_marker_alphabet(1:3))

write.xlsx(table1, "table1.xlsx", row.names = TRUE)

table1kab <- kable(table1, escape = FALSE,
      caption = "Table 1: Demographics of Vaccination Groups") %>%
  kable_styling(bootstrap_options = "striped",
                font_size = 20) %>%
  add_header_above(c("", "At Least One Dose on 3/28/21" = n_groups, "")) %>%
  pack_rows("Age \nNo. (%)", 1, 3) %>%
  pack_rows("Sex \nNo. (%)", 4, 5) %>%
  pack_rows("Race and Ethnicity \nNo. (%)", 6, 10) %>%
  column_spec(2, background = alpha(graphcolors[1], 0.5)) %>%
  column_spec(3, background = alpha(graphcolors[2], 0.5)) %>%
  column_spec(4, background = alpha(graphcolors[3], 0.5)) %>%
  # column_spec(5, background = alpha(graphcolors[4], 0.5)) %>%
  # column_spec(6, background = alpha(graphcolors[5], 0.5)) %>%
  footnote(alphabet = c("Calculated as percentage of total civilian noninstitutionalized population", 
                        "Calculated as percentage of people over 25 years old", 
                        "Calculated as population-weighted median of zip codes' median"))

table1kab

save_kable(table1kab, "table1.html")

```

# Vaccination Rollout

## Cumulative vax - all zip codes

```{r cumulative vax all zip codes}

cumulativevaxallzip <- groupsabbr %>%
  right_join(joined_df) %>%
  arrange(desc(vax_group)) %>%
  filter(week_st >= secondwavepeak) %>%
  ggplot(aes(x = week_st, y = cumulative_pct_first)) +
  geom_vline(
    data = phase_data,
    aes(xintercept = phases, linetype = phase_labels),
    color = "gray50",
    key_glyph = "path", size = 1) +
  geom_line(aes(color = vax_group, group = zip), alpha = 0.5) +
  geom_point(aes(fill = vax_group, shape = vax_group, group = zip), 
             color = "gray20",
             alpha = 0.5,
             size = 2) +
  scale_fill_manual(values = graphcolors) +
  scale_color_manual(values = graphcolors) +
  scale_shape_manual(values = graphshapes) +
  scale_linetype_manual(values = linetypes) + 
  scale_x_date(date_breaks = "4 weeks", 
               date_minor_breaks = "1 week", 
               guide = guide_axis(angle = 45),
               date_labels = "%b-%d-%Y",
               expand = c(0.01, 0.01)) +
  scale_y_continuous(limits = c(0, 100)) +
  labs(x = "\nWeek", y = "First Doses (% Population)", title = "Cumulative Vaccination - All Zip Codes",
       linetype = "Distribution Phase", color = group_legend, fill = group_legend, shape = group_legend) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(),
        axis.text=element_text(size=14, 
                               face = "bold"),
        axis.title=element_text(size=14,
                                face = "bold"),
        legend.title = element_text(size = 12,
                                    face = "bold"),
        legend.text = element_text(size = 12),
        legend.key.size = unit(1, "lines"))

cumulativevaxallzip

ggsave(paste0("cumulativevaxallzip", secondwavepeak, "_", max(to_graph$week_st), ".png"), cumulativevaxallzip, height = 6, width = 9)

```

## Cumulative vax - grouped

```{r cumulative vax}

vaxcumulative <- ggplot(data = to_graph, 
                        aes(x = week_st, y = cumulative_pct_first)) +
  aesthetics +
    theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank(),
        axis.text=element_text(size=14, 
                               face = "bold"),
        axis.title=element_text(size=14,
                                face = "bold"),
        legend.title = element_text(size = 12,
                                    face = "bold"),
        legend.text = element_text(size = 12),
        legend.key.size = unit(1, "lines")) +
  scale_y_continuous(limits = c(0, 100)) +
  labs(x = "\nWeek", y = "% of Population with First Doses\n", linetype = "Distribution Phase")

ggsave(paste0("cumulativevaxgrouped", studyperiod, ".png"), vaxcumulative, height = 6, width = 9)

```

## Weekly vax

```{r weekly vax}

vaxweekly <- ggplot(data = to_graph, aes(x = week_st, y = first_dose_weekly)) +
  aesthetics +
  labs(x = "Week", y = "Weekly First Doses/100,000 Population", title = "Trends in Weekly  Vaccination")

vaxweekly

ggsave(paste0("weeklyvax", date_cutoff, "_", max(to_graph$week_st), ".png"), vaxweekly, height = 5, width = 9)

```

# Mortality Rate

## Cumulative mortality

```{r cumulative mortality}
mortalitycumulative <-
  ggplot(data = filter(to_graph, vax_group == n_labels[1] | vax_group == n_labels[3]), aes(x = week_st, y = deaths_cumulative)) +
  aesthetics +
  scale_fill_manual(values = c(graphcolors[1], graphcolors[3])) +
  scale_color_manual(values = c(graphcolors[1], graphcolors[3])) +
  scale_shape_manual(values = c(graphshapes[1], graphshapes[3])) +
  labs(
    x = "\nWeek",
    y = "Deaths (per 100,000)\n") +
  scale_y_continuous(limits = c(0, 260))

mortalitycumulative

ggsave(paste0("cumulativemortality", studyperiod, ".png"),
       mortalitycumulative,
       height = 5,
       width = 9)

```

## Rolling average mortality

```{r rolling average weekly mortality}

rollingweeklymortality <-
  ggplot(data = to_graph, aes(x = week_st, y = mort_roll)) +
  aesthetics +
  labs(x = "\nWeek", y = "Deaths (per 100,000)\n",
    title = "Trends in COVID-19 Mortality Rate - 5 Week Rolling Averages")

rollingweeklymortality

ggsave(paste0("weeklymortality", studyperiod, ".png"), rollingweeklymortality, height = 5, width = 9)

```

## Map of cumulative mortality throughout 4th wave

```{r mortality map}

tomapmortality <- groups %>%
  right_join(dplyr::select(joined_df, -c(cumulative_pct_first, cumulative_first_weekly))) %>%
  filter(week_st >= thirdwave_st & week_st <= thirdwave_end) %>%
  filter(is.na(population) == FALSE) %>%
  mutate(vax_group = case_when(population < pop_limit ~ paste0("Suppressed (pop <", pop_limit, ")"),
                               TRUE ~ as.character(vax_group))) %>%
  dplyr::group_by(zip) %>%
  dplyr::summarise(vax_group = vax_group, 
            zip = zip, 
            population = population, 
            zip_code_location = zip_code_location,
            cumulative_pct_first = cumulative_pct_first,
            cumulative_deaths = sum(deaths_weekly) * 100000/population) %>%
  distinct() %>%
  mutate(cumulative_deaths = case_when(vax_group == paste0("Suppressed (pop <", pop_limit, ")") ~
                                         NA_real_,
                                       TRUE ~ as.numeric(cumulative_deaths))) %>%
  mutate(vax_group = factor(vax_group, levels = append(n_labels, paste0("Suppressed (pop <", pop_limit, ")")))) %>%
  left_join(zips_sf)

mortalitymap <- ggplot() + 
   geom_sf(data = tomapmortality, aes(geometry = geometry, fill = cumulative_deaths)) +
    geom_sf_text_repel(data = filter(tomapmortality, population >= pop_limit),
                               aes(label = zip, geometry = geometry),
                       size = 3,
                       # fontface = "bold",
                       nudge_x = 0,
                       nudge_y = 0,
                       point.size = NA,
                       box.padding = 0.1,
                       min.segment.length = 0.1,
                       max.overlaps = Inf) +
    theme_void() + coord_sf() + 
    scale_fill_distiller(palette = "Reds", trans = "reverse") +
    scale_color_manual(values = mapcolorscustom) +
    labs(fill = "Deaths during Spring Wave", title = "Deaths During Spring Wave") +
    theme(legend.position = "right", 
        plot.title = element_text(hjust = 0.5),
        legend.title = element_text(size = 12, face = "bold"),
        legend.text = element_text(size = 12),
        legend.key.size = unit(1, "lines")) +
  guides(color = guide_legend(override.aes = list(size=4)))

mortalitymap

ggsave("springwavemortalitymap.png", mortalitymap, height = 7, width = 7)

x <- tomapmortality$cumulative_deaths
y <- tomapmortality$cumulative_pct_first
w <- tomapmortality$population

cor(x, y)
wtd.cor(x, y, w)
```

## Distribution of deaths by vaccination group during 4th wave

```{r mortality bar}

mortalitybar <- to_graph %>%
  mutate(wave = case_when(week_st >= date_cutoff & week_st < secondwave_st ~ 1,
                          week_st >= secondwave_st & week_st < thirdwave_st ~ 2,
                          week_st >= thirdwave_st & week_st <= thirdwave_end ~ 3)) %>%
  filter(is.na(wave) == FALSE) %>%
  dplyr::group_by(vax_group, wave) %>%
  dplyr::summarise(cumulative_deaths_abs = sum(death_rate_weekly*population/100000)) %>%
  dplyr::group_by(wave) %>%
  mutate(pct_deaths = (cumulative_deaths_abs/sum(cumulative_deaths_abs))*100) %>%
  ggplot(aes(x = wave, y = pct_deaths, fill = vax_group)) +
    geom_bar(position = "dodge", stat = "identity") +
    geom_text(aes(x = wave, label = paste0(cumulative_deaths_abs, "(", round(pct_deaths), ")")), 
              position = position_dodge2(width = 0.9, preserve = "single"),
              vjust = 1.5,
              fontface = "bold",
              size = 6) +
    scale_fill_manual(values = graphcolors) +
    labs(y = "% of Deaths\n", x = "\nWave", title = "Deaths during waves by vaccination group\n",
         fill = group_legend) +
  theme_bw() +
  scale_y_continuous(expand = c(0,0), limits = c(0, 70),
                     breaks = seq(0, 70, 10)) +
  theme(panel.grid.minor = element_blank(), panel.grid.major.x = element_blank(), 
        panel.grid.major.y = element_line(color = "gray20")) +
  theme(axis.text=element_text(size=16, 
                               face = "bold"),
        axis.title=element_text(size=18,
                                face = "bold"),
        legend.title = element_text(size = 16,
                                    face = "bold"),
        legend.text = element_text(size = 16),
        legend.key.size = unit(2, "lines"))

mortalitybar

ggsave("mortalitybar.png", mortalitybar, width = 12, height = 7)
```

# New Cases

## Grouped by vaccinations just before Phase 2

```{r weekly new cases}

newcasesroll <- to_graph %>%
  dplyr::group_by(vax_group) %>%
  mutate(caseroll = zoo::rollmean(case_rate_weekly, k, fill = NA)) %>%
  ungroup() %>%
  ggplot(aes(x = week_st, y = caseroll)) +
  aesthetics +
  labs(x = "\nWeek", y = "New Cases (per 100,000)\n",
    title = "Trends in COVID-19 Cases after Vaccination")

newcasesroll

ggsave(paste0("weeklycases", studyperiod, ".png"), newcasesroll, height = 5, width = 9)
```

# Difference-in-Difference

If low group had been vaccinated at same rate as high group

```{r DID dataset}

# Started DID at Phase 1C activation (4 weeks after weekly vaccination trends started to diverge)

DID_stdate <- grouping_date

DID_st <- to_graph %>%
  filter(week_st == grouping_date)

to_did <- to_graph %>%
  # difference from t0 (DID_st) in high and low groups
  mutate(
    diff0total = case_when(
      vax_group == factor(n_labels)[1] ~ DID_st$deaths_cumulative[1] - deaths_cumulative,
      vax_group == factor(n_labels)[n_groups] ~ DID_st$deaths_cumulative[n_groups] - deaths_cumulative),
    diff0weekly = case_when(
      vax_group == factor(n_labels)[1] ~ DID_st$death_rate_weekly[1] - death_rate_weekly,
      vax_group == factor(n_labels)[n_groups] ~ DID_st$death_rate_weekly[n_groups] - death_rate_weekly),
    diff0wkroll = case_when(
      vax_group == factor(n_labels)[1] ~ DID_st$mort_roll[1] - mort_roll,
      vax_group == factor(n_labels)[n_groups] ~ DID_st$mort_roll[n_groups] - mort_roll)) %>%
  # make it subtractable
  dplyr::group_by(week_st) %>%
  mutate(diff1total = rev(diff0total), 
         diff1weekly = rev(diff0weekly),
         diff1wkroll = rev(diff0wkroll)) %>%
  ungroup() %>%
  mutate(absdeaths_counterfactual = case_when(
            week_st >= DID_stdate & vax_group == factor(n_labels)[1] ~ 
               DID_st$deaths_cumulative[1]-diff1total,
            week_st >= DID_stdate & vax_group == factor(n_labels)[n_groups] ~
               DID_st$deaths_cumulative[n_groups]-diff1total),
         absdeath_rate_weekly_counterfactual = case_when(
            week_st >= DID_stdate & vax_group == factor(n_labels)[1] ~ 
               DID_st$death_rate_weekly[1] - diff1weekly,
            week_st >= DID_stdate & vax_group == factor(n_labels)[n_groups] ~
               DID_st$death_rate_weekly[n_groups] - diff1weekly),
         abs_wkroll_counterfactual = case_when(
            week_st >= DID_stdate & vax_group == factor(n_labels)[1] ~
              DID_st$mort_roll[1] - diff1wkroll,
            week_st >= DID_stdate & vax_group == factor(n_labels)[n_groups] ~
              DID_st$mort_roll[n_groups] - diff1wkroll)) %>%
  mutate(diff0rel = case_when(
            vax_group == factor(n_labels)[1] ~ deaths_cumulative/DID_st$deaths_cumulative[1],
            vax_group == factor(n_labels)[n_groups] ~ 
               deaths_cumulative/DID_st$deaths_cumulative[n_groups])) %>%
  dplyr::group_by(week_st) %>%
  mutate(diff1rel = rev(diff0rel)) %>%
  ungroup() %>%
  mutate(reldeaths_counterfactual = case_when(
            week_st >= DID_stdate & vax_group == factor(n_labels)[1] ~ 
               DID_st$deaths_cumulative[1]*diff1rel,
            week_st >= DID_stdate & vax_group == factor(n_labels)[n_groups] ~
               DID_st$deaths_cumulative[n_groups]*diff1rel))
```

## Cumulative mortality - absolute DID

Figure out the legend

```{r cumulative mortality DID abs}
mortalitycumulativedid <- mortalitycumulative +
  # filtered out counterfactuals for high group
  geom_point(data = filter(to_did, vax_group == n_labels[1]), 
             aes(x = week_st, y = absdeaths_counterfactual, fill = "Counterfactual", color = "Counterfactual", shape = "Counterfactual"),
             size = 3) +
  # filtered out counterfactuals for high group
  geom_line(data = filter(to_did, vax_group == n_labels[1]), 
            aes(x = week_st, y = absdeaths_counterfactual, group = vax_group, color = "Counterfactual"), 
            linetype = "dashed") +
  scale_fill_manual(values = c(graphcolors[1], graphcolors[3], "#FFFFFF")) +
  scale_color_manual(values = c(graphcolors[1], graphcolors[3], "#FF0000")) +
  scale_shape_manual(values = c(graphshapes[1], graphshapes[3], 1)) +
  labs(color = group_legend, fill = group_legend, shape = group_legend)
  
mortalitycumulativedid

ggsave(paste0("didcumulativemortality", studyperiod, ".png"), mortalitycumulativedid, height = 5, width = 9)

lowdid <- to_did %>%
  filter(week_st == thirdwave_end, vax_group == n_labels[1])
lowdidlivessaved <- (lowdid$deaths_cumulative-lowdid$absdeaths_counterfactual)*lowdid$population/100000
paste("Lives saved if lowest vaccinated zip codes experienced same trend as highly vaccinated:", lowdidlivessaved)

```

### DID with rolling average of weekly mortality

```{r DID with rolling mortality}
rollingmortdid <- rollingweeklymortality +
  # filtered out counterfactuals for high group
  geom_point(data = filter(to_did, vax_group == n_labels[1]), 
             aes(x = week_st, y = abs_wkroll_counterfactual, 
                 shape = vax_group), color = "red", size = 3, show.legend = FALSE) +
  # filtered out counterfactuals for high group
  geom_line(data = filter(to_did, vax_group == n_labels[1]), 
            aes(x = week_st, y = abs_wkroll_counterfactual, group = vax_group),
            color = "red", linetype = "dashed") +
  geom_vline(xintercept = mean(DID_st$week_st), color = "red")

ggsave(paste0("didweeklymortality", studyperiod, ".png"), rollingmortdid, height = 5, width = 9)
```

# Model Fitting

## Model 1:

$log(Y_i)-log(pop_i)=\beta_{0i}+\beta_{1i}week+\beta_2wave+\beta_3wave*vaxleveldec$

```{r modeling dataset}

start <- secondwavepeak
chngwave <- thirdwave_st
end <- mdy("6/14/21")

wave2 <- interval(start, thirdwave_st)
wave3 <- interval(thirdwave_st, thirdwave_end)

chngwavenum <- (start %--% chngwave) %/% weeks(1) + 1

# Want to know cumulative % of first doses 6 weeks before peak of 3rd wave
grouping_date <- mdy("3/28/21")

vaxlevel <- joined_df %>%
  filter(week_st == grouping_date, population >= pop_limit) %>%
  # deciles 
  mutate(vaxleveldec = cumulative_pct_first / 10,
         completeleveldec = cumulative_pct_complete / 10,
         recoveredleveldec = (cases_cumulative - deaths_cumulative)/population * 10) %>%
  dplyr::select(zip, population, vaxleveldec, recoveredleveldec, completeleveldec)

age_by_zip <- demo_by_zip %>%
  rename(pop65plus = `Population - Age 65+`) %>%
  mutate(dec65plus = pop65plus/population * 10) %>%
  filter(population >= pop_limit) %>%
  dplyr::select(zip, dec65plus)

mixedeffectsdf <- joined_df %>%
  filter(week_st >= start, population >= pop_limit) %>%
  # reindex weeks to be since beginning of 3rd wave
  mutate(week = week-min(week),
         wave = case_when(week_st %within% wave2 ~ 0,
                          week_st %within% wave3 ~ 1)) %>%
  left_join(vaxlevel) %>% 
  left_join(age_by_zip) %>%
  dplyr::group_by(wave) %>%
  mutate(wave_week = week - min(week)) %>%
  dplyr::group_by(wave, zip) %>%
  mutate(deaths_wave = max(deaths_cumulative) - min(deaths_cumulative)) %>%
  arrange(week_st) %>%
  dplyr::group_by(zip) %>%
  mutate(vaxleveldeclag = dplyr::lag(cumulative_pct_complete, 6)/10) %>%
  ungroup () %>%
  filter(is.na(wave) == FALSE) %>%
  left_join(groupsabbr) %>%
  mutate(vax_group = relevel(vax_group , ref = n_labels[n_groups]))

write.csv(mixedeffectsdf, "mixedeffectsdf.csv")

```

```{r model 1 parallel slope test}

model1 <- glm(data = filter(mixedeffectsdf, wave == 0), deaths_weekly ~ week*vax_group + offset(log(population)), family = poisson(link = "log"))

tab_model(model1, transform = NULL, show.ci = FALSE, show.se = TRUE)

linearHypothesis(model1, c("week:vax_group[17.8, 26.9] = 0", "week:vax_group[27.6, 39.4] = 0"))

```

## Model 2

```{r model 2 mixed effects}
# Random effects on intercept from zip and week
model2 <- glmer(data = mixedeffectsdf, deaths_weekly ~ (1 + week|zip) + week + wave + wave:vaxleveldec + offset(log(population)), family = poisson(link = "log"))

model2

model2noslope <- glmer(data = mixedeffectsdf, deaths_weekly ~ (1|zip) + week + wave + wave:vaxleveldec + offset(log(population)), family = poisson(link = "log"))

model2noslope

# Mixed-Effects Model Visualization
# ggpredict(model1, terms = c("wave", "zip"), type = "random") %>%
#   ggplot(aes(x = x, 
#              y = predicted, 
#              color = group)) +
#   geom_line() +
#   labs(y = "Fitted Weekly Deaths",
#        x = "Week",
#        color = "ZIP")
```

Model 2b: 6-week lag on vaccination effect

```{r model2b vax level 6 weeks prior}

model2b <- glmer(data = mixedeffectsdf, deaths_weekly ~ (1|zip) + week + wave + wave:vaxleveldeclag + offset(log(population)), family = poisson(link = "log"))

model2b

```

## Model 3:

$log(Y_i)-log(pop_i)=\beta_{0i}+\beta_{1i}week+\beta_2wave+\beta_3wave*vaxleveldec+\beta_4recoveredleveldec+\beta_5dec65plus$

```{r model 3 recovered and aging and IRRS}

# not sure how to account for people who were recovered + vaccinated

model3 <- glmer(data = mixedeffectsdf, deaths_weekly ~ (1|zip) + week + wave + wave:vaxleveldec + recoveredleveldec + dec65plus + offset(log(population)), family = poisson(link = "log"))

model3

# Wave IRR with mean values

paste("Wave IRR with mean vaccination level (Model 2 no slope):", exp(fixef(model2noslope)[3] + 
      fixef(model2noslope)[4]*mean(vaxlevel$vaxleveldec)))

paste("Wave IRR with mean vaccination level (Model 3):", exp(fixef(model3)[3] + 
      fixef(model3)[6]*mean(vaxlevel$vaxleveldec)))

# Week IRR with median values

paste("Week IRR with mean vaccination level (Model 2 no slope):", exp(fixef(model2noslope)[2] + 
      fixef(model2noslope)[4]*mean(vaxlevel$vaxleveldec)))

paste("Week IRR with mean vaccination level (Model 3):", exp(fixef(model3)[2] + 
      fixef(model3)[6]*mean(vaxlevel$vaxleveldec)))

```

Model 3b: 

```{r model3c vax level groups}

model3b <- glmer(data = mixedeffectsdf, deaths_weekly ~ (1|zip) + week + wave + wave:vax_group + recoveredleveldec + dec65plus + offset(log(population)), family = poisson(link = "log"))

tab_model(model3b, transform = NULL, show.ci = FALSE, show.se = TRUE)

```

IRRs
```{r tab model}

tab_model(model2noslope, model3,
title = "Table 2: Multivariable analysis of risk reduction in deaths from COVID-19, by vaccinations before third wave")

tab_model(model2noslope, model3, transform = NULL, show.ci = FALSE, show.se = TRUE)

paste("Wave IRR with mean vaccination level (Model 3c groups):", (exp(fixef(model3b)[3] + 
      fixef(model3b)[7])))

paste("Week IRR with mean vaccination level (Model 3):", exp(fixef(model3)[2] + 
      fixef(model3)[6]*mean(vaxlevel$vaxleveldec)))

```

vaxleveldec = 10% increase in people with first doses out of entire population; recoveredleveldec = 10% increase in recovered from COVID-19 out of entire population; dec65plus = 10% increase in people over 65 years old out of entire population

```{r model 4 complete vax}

model4 <- glmer(data = mixedeffectsdf, deaths_weekly ~ (1|zip) + week + wave + wave:completeleveldec + recoveredleveldec + dec65plus + offset(log(population)), family = poisson(link = "log"))

tab_model(model4, transform = NULL, show.ci = FALSE, show.se = TRUE)

paste("Wave IRR with mean vaccination level (Model 4):", exp(fixef(model3)[3] + 
      fixef(model3)[6]*mean(vaxlevel$completeleveldec)))

# Week IRR with median values

paste("Week IRR with mean vaccination level (Model 4):", exp(fixef(model4)[2] + 
      fixef(model4)[6]*mean(vaxlevel$completeleveldec)))
```


```{r model 3 did}

diddata <- mixedeffectsdf %>% 
  arrange(vaxleveldec) %>%
  mutate(vaxleveldec = rev(vaxleveldec))

didsim <- simulate(model3, newdata = diddata)

diddata <- cbind(diddata, didsim)

model3did <- groups %>%
  dplyr::group_by(vax_group) %>%
  mutate(group_pop = sum(population)) %>%
  ungroup() %>%
  dplyr::select(vax_group, zip, group_pop) %>%
  left_join(diddata) %>%
  dplyr::group_by(vax_group, week) %>%
  dplyr::summarise(death_rate_weekly = sum(deaths_weekly)*100000/group_pop,
            diddeath_rate_weekly = sum(sim_1)*100000/group_pop,
            population = group_pop) %>%
  ungroup() %>%
  unique() %>%
  arrange(week) %>%
  dplyr::group_by(vax_group) %>%
  mutate(rollingavgdeathrate = zoo::rollmean(death_rate_weekly, k, fill = NA)) %>%
  ungroup()

model3didplot <- ggplot(data = model3did) +
  geom_line(aes(x = week, y = rollingavgdeathrate, color = vax_group), alpha = 0.5) +
  geom_point(aes(x = week, y = diddeath_rate_weekly, fill = vax_group, shape = vax_group), size = 3) +
  scale_fill_manual(values = graphcolors) +
  scale_color_manual(values = graphcolors) +
  scale_shape_manual(values = graphshapes) +
  theme_bw() +
  labs(title = "DID with model 2", paste("Predicted values from flipped", group_legend), color = group_legend, fill = paste("Predicted values from flipped", group_legend),
       y = "Weekly Mortality Rate (per 100,000 population)", x = "Weeks since 10/24/20")

model3didplot

# Lives saved under flipped allocation before 3rd wave

sim_1 <- diddata %>%
  dplyr::group_by(week) %>%
  dplyr::summarise(sim_1 = sum(sim_1)) %>%
  filter(week >= chngwavenum)

# Estimated number of deaths if low zip codes had gotten high vaccination level using area under curve
AUC(sim_1$week, sim_1$sim_1, method = "trapezoid")

test <- mixedeffectsdf %>%
  filter(week == max(week), wave == 1) %>%
  mutate(deaths_wave = sum(deaths_wave))

test$deaths_wave[1]
```
